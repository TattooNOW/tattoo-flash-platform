<!--
=================================================================
TATTOO DESIGN GALLERY - ADMIN
=================================================================
Self-contained HTML/CSS/JS for GHL Custom Code element.
Manages tattoo designs in Airtable via n8n webhook proxy.
Supports: List, Add, Edit, Delete operations.

Configuration:
- Set window.TNOW_LOCATION_ID before this script, OR
- Pass ?locationId=XXX in the URL
=================================================================
-->

<div class="tnow-admin slim-mode" id="tattooAdmin">
    <!-- Dev Banner -->
    <div style="background:#ff4444;color:#fff;text-align:center;padding:8px;font-family:sans-serif;font-weight:bold;font-size:1.1rem;">DEV BRANCH - TEST MODE</div>
    <!-- Header -->
    <div class="tnow-admin-header">
        <h1 class="tnow-admin-title">Tattoo Designs</h1>
        <button class="tnow-add-btn" id="headerActionBtn" onclick="TattooAdmin.openAdd()">+ Add Design</button>
    </div>

    <!-- Page-Level Tabs -->
    <div class="tnow-page-tabs" id="pageTabs" style="display:none;">
        <button class="tnow-page-tab active" data-view="designs" onclick="TattooAdmin.switchView('designs')">Designs</button>
        <button class="tnow-page-tab" data-view="categories" id="tabCategories" onclick="TattooAdmin.switchView('categories')">Styles & Subjects <span id="pendingCount" class="tnow-pending-count"></span></button>
        <button class="tnow-page-tab" data-view="catalog" id="tabCatalog" onclick="TattooAdmin.switchView('catalog')">Community Catalog</button>
    </div>

    <!-- Categories Approval View (TattooNOW only) -->
    <div class="tnow-categories-view" id="categoriesView" style="display:none;">
        <div class="tnow-categories-loading" id="categoriesLoading" style="display:none;">
            <div class="tnow-spinner"></div>
            <p>Loading pending categories...</p>
        </div>
        <div class="tnow-categories-empty" id="categoriesEmpty" style="display:none;">
            <span class="tnow-empty-icon">‚úÖ</span>
            <p>No pending category requests.</p>
        </div>
        <div class="tnow-admin-table-wrap" id="categoriesTableWrap" style="display:none;">
            <table class="tnow-admin-table">
                <thead>
                    <tr>
                        <th style="width:60px;">Icon</th>
                        <th>Name</th>
                        <th>Slug</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="categoriesTableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Community Catalog View -->
    <div id="catalogView" style="display:none;">
        <div class="tnow-catalog-search">
            <input type="text" class="tnow-search-input" id="catalogSearch" placeholder="Search community designs..." autocomplete="off" oninput="TattooAdmin.filterCatalog()">
            <span class="tnow-search-icon">üîç</span>
        </div>
        <div class="tnow-admin-loading" id="catalogLoading" style="display:none;">
            <div class="tnow-spinner"></div>
            <p>Loading community catalog...</p>
        </div>
        <div class="tnow-admin-empty" id="catalogEmpty" style="display:none;">
            <span class="tnow-empty-icon">üì¶</span>
            <p>No shared designs available yet.</p>
        </div>
        <div class="tnow-catalog-grid" id="catalogGrid"></div>
    </div>

    <!-- Search & Filter -->
    <div class="tnow-admin-toolbar">
        <div class="tnow-search-wrap">
            <input type="text" class="tnow-search-input" id="adminSearch" placeholder="Search designs..." autocomplete="off">
            <span class="tnow-search-icon">üîç</span>
        </div>
        <label class="tnow-filter-check" id="featuredFilter">
            <input type="checkbox" id="featuredCheckbox">
            <span class="tnow-check-mark"></span>
            <span>Featured</span>
        </label>
        <select class="tnow-filter-select" id="sizeFilter">
            <option value="all">All Sizes</option>
            <option value="Small">Small</option>
            <option value="Medium">Medium</option>
            <option value="Large">Large</option>
            <option value="XL">XL</option>
        </select>
        <select class="tnow-filter-select" id="priceFilter">
            <option value="all">All Prices</option>
            <option value="under500">Under $500</option>
            <option value="500to1000">$500 - $1,000</option>
            <option value="1000to2000">$1,000 - $2,000</option>
            <option value="over2000">Over $2,000</option>
        </select>
        <select class="tnow-filter-select" id="statusFilter">
            <option value="all">All Status</option>
            <option value="available">Available</option>
            <option value="unavailable">Unavailable</option>
        </select>
        <div class="tnow-thumb-toggle">
            <button class="tnow-thumb-btn active" data-size="small" onclick="TattooAdmin.setThumbSize('small')" title="Small thumbnails">‚äû</button>
            <button class="tnow-thumb-btn" data-size="large" onclick="TattooAdmin.setThumbSize('large')" title="Large thumbnails">‚ä°</button>
        </div>
    </div>

    <!-- Style Navigation -->
    <div class="tnow-category-nav" id="categoryNav">
        <button class="tnow-cat-btn active" data-category="all">
            <span class="tnow-cat-icon">üé®</span>
            <span class="tnow-cat-label">All Styles</span>
        </button>
        <!-- Dynamic style buttons inserted here -->
    </div>

    <!-- Subject Navigation -->
    <div class="tnow-category-nav" id="subjectNav" style="margin-top:-0.5rem;">
        <button class="tnow-cat-btn active" data-subject="all">
            <span class="tnow-cat-icon">üè∑Ô∏è</span>
            <span class="tnow-cat-label">All Subjects</span>
        </button>
        <!-- Dynamic subject buttons inserted here -->
    </div>

    <!-- Add Category Modal -->
    <div class="tnow-modal" id="addCategoryModal" style="display:none;">
        <div class="tnow-modal-backdrop" onclick="TattooAdmin.closeAddCategory()"></div>
        <div class="tnow-modal-content tnow-modal-confirm">
            <h3>Request New Category</h3>
            <p class="tnow-approval-note">New categories require TattooNOW approval before going live.</p>
            <div style="text-align:left;">
                <div class="tnow-form-group" style="margin-bottom:1rem;">
                    <label for="newCatName">Category Name *</label>
                    <input type="text" id="newCatName" placeholder="e.g., Tribal">
                </div>
                <div class="tnow-form-group" style="margin-bottom:1rem;">
                    <label for="newCatIcon">Icon (emoji)</label>
                    <input type="text" id="newCatIcon" placeholder="üé®" maxlength="4">
                </div>
            </div>
            <div class="tnow-form-actions">
                <button type="button" class="tnow-btn-secondary" onclick="TattooAdmin.closeAddCategory()">Cancel</button>
                <button type="button" class="tnow-btn-primary" id="saveCatBtn" onclick="TattooAdmin.saveCategory()">Submit Request</button>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div class="tnow-admin-loading" id="adminLoading">
        <div class="tnow-spinner"></div>
        <p>Loading designs...</p>
    </div>

    <!-- Error State -->
    <div class="tnow-admin-error" id="adminError" style="display:none;">
        <span class="tnow-error-icon">‚ö†Ô∏è</span>
        <p id="errorMessage">Unable to load designs.</p>
        <button class="tnow-retry-btn" onclick="TattooAdmin.refresh()">Retry</button>
    </div>

    <!-- Designs Table -->
    <div class="tnow-admin-table-wrap" id="adminTableWrap" style="display:none;">
        <table class="tnow-admin-table" id="adminTable">
            <thead>
                <tr>
                    <th class="col-image">Image</th>
                    <th class="col-name">Design</th>
                    <th class="col-category">Style</th>
                    <th class="col-subject">Subject</th>
                    <th class="col-size">Size</th>
                    <th class="col-price">Price</th>

                    <th class="col-status">Status</th>
                    <th class="col-actions">Actions</th>
                </tr>
            </thead>
            <tbody id="adminTableBody"></tbody>
        </table>
    </div>

    <!-- Empty State -->
    <div class="tnow-admin-empty" id="adminEmpty" style="display:none;">
        <span class="tnow-empty-icon">üé®</span>
        <p>No designs found.</p>
        <button class="tnow-add-btn" onclick="TattooAdmin.openAdd()">Add Your First Design</button>
    </div>

    <!-- Add/Edit Modal -->
    <div class="tnow-modal" id="adminModal" style="display:none;">
        <div class="tnow-modal-backdrop" onclick="TattooAdmin.closeModal()"></div>
        <div class="tnow-modal-content tnow-modal-form">
            <div class="tnow-modal-header">
                <h2 id="modalTitle">Add Design</h2>
                <button class="tnow-modal-close" onclick="TattooAdmin.closeModal()">&times;</button>
            </div>
            <form id="designForm" class="tnow-form" onsubmit="TattooAdmin.saveDesign(event)">
                <input type="hidden" id="designId" value="">

                <!-- Tab Navigation -->
                <div class="tnow-form-tabs">
                    <button type="button" class="tnow-tab active" data-tab="images" onclick="TattooAdmin.switchTab('images')">Design</button>
                    <button type="button" class="tnow-tab" data-tab="categories" onclick="TattooAdmin.switchTab('categories')">Style</button>
                    <button type="button" class="tnow-tab" data-tab="subjects" onclick="TattooAdmin.switchTab('subjects')">Subject</button>
                    <button type="button" class="tnow-tab" data-tab="details" onclick="TattooAdmin.switchTab('details')">Details</button>
                    <button type="button" class="tnow-tab" data-tab="advanced" onclick="TattooAdmin.switchTab('advanced')">Submit</button>
                </div>

                <!-- Tab 1: Images (Design Image + Line Drawing) -->
                <div class="tnow-tab-panel active" id="tabImages">
                    <!-- Design Image Upload -->
                    <div class="tnow-image-section">
                        <h3 class="tnow-section-title">Design Image *</h3>
                        <div class="tnow-file-upload" id="fileUploadZone">
                            <input type="file" id="designImageFile" accept="image/*" onchange="TattooAdmin.handleFileSelect(event, 'design')">
                            <input type="hidden" id="designImage" value="">
                            <div class="tnow-file-upload-content" id="uploadContent">
                                <span class="tnow-upload-icon">üìÅ</span>
                                <span class="tnow-upload-text">Click to upload or drag & drop</span>
                                <small>PNG, JPG, GIF up to 10MB</small>
                            </div>
                            <div class="tnow-file-uploading" id="uploadingState" style="display:none;">
                                <div class="tnow-spinner-small"></div>
                                <span>Uploading to GHL...</span>
                            </div>
                        </div>
                        <div class="tnow-form-row" id="imagePreviewRow" style="display:none;">
                            <div class="tnow-form-group full">
                                <div class="tnow-image-preview">
                                    <img id="imagePreview" src="" alt="Preview">
                                    <button type="button" class="tnow-remove-image" onclick="TattooAdmin.removeImage('design')">&times;</button>
                                </div>
                                <small class="tnow-image-url" id="imageUrlDisplay"></small>
                            </div>
                        </div>
                    </div>

                    <!-- Line Sheet Upload -->
                    <div class="tnow-image-section tnow-linesheet-section">
                        <h3 class="tnow-section-title">Line Sheet / Drawing <small>(optional)</small></h3>
                        <div class="tnow-file-upload tnow-file-upload-slim" id="lineSheetUploadZone">
                            <input type="file" id="lineSheetFile" accept="image/*" onchange="TattooAdmin.handleFileSelect(event, 'linesheet')">
                            <input type="hidden" id="designLineSheet" value="">
                            <div class="tnow-file-upload-content" id="lineSheetUploadContent">
                                <span class="tnow-upload-text">Click to upload line sheet</span>
                            </div>
                            <div class="tnow-file-uploading" id="lineSheetUploadingState" style="display:none;">
                                <div class="tnow-spinner-small"></div>
                                <span>Uploading...</span>
                            </div>
                        </div>
                        <div class="tnow-form-row" id="lineSheetPreviewRow" style="display:none;">
                            <div class="tnow-form-group full">
                                <div class="tnow-image-preview">
                                    <img id="lineSheetPreview" src="" alt="Line Sheet Preview">
                                    <button type="button" class="tnow-remove-image" onclick="TattooAdmin.removeImage('linesheet')">&times;</button>
                                </div>
                                <small class="tnow-image-url" id="lineSheetUrlDisplay"></small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab 2: Style (Multi-select) -->
                <div class="tnow-tab-panel" id="tabCategories">
                    <label class="tnow-picker-label">Select Styles *</label>
                    <p class="tnow-picker-hint"><strong>Style</strong> is the artistic technique or tradition ‚Äî how the tattoo is drawn. Examples: Traditional, Realism, Watercolor.</p>
                    <div class="tnow-category-picker" id="categoryPicker">
                        <!-- Dynamically rendered style pills -->
                    </div>
                </div>

                <!-- Tab 2b: Subject (Multi-select, optional) -->
                <div class="tnow-tab-panel" id="tabSubjects">
                    <label class="tnow-picker-label">Select Subjects</label>
                    <p class="tnow-picker-hint"><strong>Subject</strong> is what the tattoo depicts ‚Äî the content or theme. Examples: Animals, Mythology, Skulls. (optional)</p>
                    <div class="tnow-category-picker" id="subjectPicker">
                        <!-- Dynamically rendered subject pills -->
                    </div>
                </div>

                <!-- Tab 3: Details (Basic Info) -->
                <div class="tnow-tab-panel" id="tabDetails">
                    <div class="tnow-form-row">
                        <div class="tnow-form-group full">
                            <label for="designName">Design Name *</label>
                            <input type="text" id="designName" placeholder="e.g., American Eagle">
                        </div>
                    </div>

                    <div class="tnow-form-row">
                        <div class="tnow-form-group full">
                            <label for="designDescription">Description</label>
                            <textarea id="designDescription" rows="3" placeholder="Describe the design..."></textarea>
                        </div>
                    </div>

                    <div class="tnow-form-row">
                        <div class="tnow-form-group">
                            <label for="designSize">Size Estimate</label>
                            <select id="designSize">
                                <option value="">Select size...</option>
                                <option value="Small">Small</option>
                                <option value="Medium">Medium</option>
                                <option value="Large">Large</option>
                                <option value="XL">XL</option>
                            </select>
                        </div>
                        <div class="tnow-form-group">
                            <label for="designBodyPart">Perfect Body Part</label>
                            <input type="text" id="designBodyPart" placeholder="e.g., Forearm, Shoulder">
                        </div>
                    </div>
                </div>

                <!-- Tab 3: Submit (Options & Save) -->
                <div class="tnow-tab-panel" id="tabAdvanced">
                    <div class="tnow-submit-options">
                        <label class="tnow-toggle" title="Uncheck to hide from public gallery">
                            <input type="checkbox" id="designAvailable" checked>
                            <span class="tnow-toggle-label">Available</span>
                            <span class="tnow-toggle-tip">Visible to customers</span>
                        </label>
                        <label class="tnow-toggle" title="Shows in featured sections and category thumbnails">
                            <input type="checkbox" id="designFeatured">
                            <span class="tnow-toggle-label">Featured</span>
                            <span class="tnow-toggle-tip">Highlight in gallery</span>
                        </label>
                        <label class="tnow-toggle" title="This design can only be tattooed once. After it's booked, it will be marked as Taken.">
                            <input type="checkbox" id="designOneTimeFlash">
                            <span class="tnow-toggle-label">1x Design</span>
                            <span class="tnow-toggle-tip">This design can only be tattooed once</span>
                        </label>
                        <label class="tnow-toggle" title="Share with TattooNOW Design Catalog (requires approval)">
                            <input type="checkbox" id="designCommunity">
                            <span class="tnow-toggle-label">Share</span>
                            <span class="tnow-toggle-tip">Submit to TattooNOW Community Catalog</span>
                        </label>
                    </div>

                    <div class="tnow-form-row">
                        <div class="tnow-form-group">
                            <label for="designTime">Time Estimate</label>
                            <input type="text" id="designTime" placeholder="e.g., 2-4 hours">
                        </div>
                        <div class="tnow-form-group">
                            <label for="designPrice">Price Range</label>
                            <input type="text" id="designPrice" placeholder="e.g., $300-500">
                        </div>
                    </div>

                    <div class="tnow-form-row">
                        <div class="tnow-form-group">
                            <label for="designArtist">Original Artist</label>
                            <input type="text" id="designArtist" placeholder="Artist name (internal reference)">
                        </div>
                        <div class="tnow-form-group">
                            <label for="designSort">Sort Order</label>
                            <input type="number" id="designSort" placeholder="1" min="1">
                            <small>Lower numbers appear first</small>
                        </div>
                    </div>
                </div>

                <div class="tnow-form-actions">
                    <button type="button" class="tnow-btn-secondary" onclick="TattooAdmin.closeModal()">Cancel</button>
                    <button type="button" class="tnow-btn-primary" id="nextBtn" onclick="TattooAdmin.nextTab()">Next</button>
                    <button type="submit" class="tnow-btn-primary" id="saveBtn" style="display:none;">Save Design</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="tnow-modal" id="deleteModal" style="display:none;">
        <div class="tnow-modal-backdrop" onclick="TattooAdmin.closeDeleteModal()"></div>
        <div class="tnow-modal-content tnow-modal-confirm">
            <h3 id="deleteTitle">Delete Design?</h3>
            <p id="deleteMessage">Are you sure you want to delete "<span id="deleteName"></span>"?</p>
            <p class="tnow-warning" id="deleteWarning">This action cannot be undone.</p>
            <div class="tnow-form-actions">
                <button type="button" class="tnow-btn-secondary" onclick="TattooAdmin.closeDeleteModal()">Cancel</button>
                <button type="button" class="tnow-btn-danger" id="deleteConfirmBtn" onclick="TattooAdmin.confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="tnow-toast-container" id="toastContainer"></div>
</div>

<style>
/* =================================================================
   CSS VARIABLES (TattooNOW Brand)
   ================================================================= */
.tnow-admin {
    --tnow-orange: #fa9101;
    --tnow-orange-dark: #cd7600;
    --tnow-gold: #F8A507;
    --tnow-black: #000000;
    --tnow-navy: #000321;
    --tnow-white: #ffffff;
    --tnow-gray: #8893A8;
    --tnow-gray-light: #C9D8E0;
    --tnow-red: #e53e3e;
    --tnow-green: #38a169;

    --card-bg: rgba(255, 255, 255, 0.03);
    --card-border: rgba(255, 255, 255, 0.1);
    --text-muted: #a0a0a0;

    --font-headline: 'Roboto Slab', 'Arial Black', sans-serif;
    --font-body: 'Roboto', Arial, sans-serif;

    --radius-sm: 4px;
    --radius-md: 8px;
    --radius-lg: 12px;

    font-family: var(--font-body);
    color: var(--tnow-white);
    padding: 1rem;
}

/* =================================================================
   HEADER
   ================================================================= */
.tnow-admin-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.tnow-admin-title {
    font-family: var(--font-headline);
    font-size: 1.75rem;
    margin: 0;
    color: var(--tnow-white);
}

.tnow-add-btn {
    padding: 0.75rem 1.25rem;
    background: var(--tnow-orange);
    border: none;
    border-radius: var(--radius-md);
    color: var(--tnow-black);
    font-family: var(--font-body);
    font-weight: 700;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.tnow-add-btn:hover {
    background: var(--tnow-gold);
    transform: translateY(-1px);
}

/* =================================================================
   TOOLBAR
   ================================================================= */
.tnow-admin-toolbar {
    display: flex;
    gap: 1rem;
    margin-bottom: 0;
    flex-wrap: wrap;
    background: rgba(0, 3, 33, 0.6);
    padding: 1rem 1.25rem;
    border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-bottom: none;
}

.tnow-admin-toolbar .tnow-filter-select,
.tnow-admin-toolbar .tnow-filter-check,
.tnow-admin-toolbar .tnow-search-input {
    background: rgba(255, 255, 255, 0.06);
    border-color: rgba(255, 255, 255, 0.12);
}

.tnow-search-wrap {
    position: relative;
    flex: 1;
    min-width: 200px;
}

.tnow-search-input {
    width: 100%;
    padding: 0.75rem 1rem 0.75rem 2.5rem;
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-md);
    color: var(--tnow-white);
    font-family: var(--font-body);
    font-size: 0.9rem;
    outline: none;
    transition: border-color 0.2s ease;
}

.tnow-search-input:focus {
    border-color: var(--tnow-orange);
}

.tnow-search-input::placeholder {
    color: var(--text-muted);
}

.tnow-search-icon {
    position: absolute;
    left: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
}

.tnow-filter-select {
    padding: 0.75rem 1rem;
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-md);
    color: var(--tnow-white);
    font-family: var(--font-body);
    font-size: 0.9rem;
    outline: none;
    cursor: pointer;
    min-width: 160px;
}

.tnow-filter-select:focus {
    border-color: var(--tnow-orange);
}

.tnow-filter-select option {
    background: var(--tnow-navy);
}

.tnow-filter-check {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.6rem 1rem;
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-md);
    color: var(--tnow-white);
    font-family: var(--font-body);
    font-size: 0.85rem;
    cursor: pointer;
    transition: border-color 0.2s ease;
    white-space: nowrap;
}

.tnow-filter-check:hover {
    border-color: var(--tnow-orange);
}

.tnow-filter-check input {
    display: none;
}

.tnow-check-mark {
    width: 18px;
    height: 18px;
    border: 2px solid var(--card-border);
    border-radius: 4px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

.tnow-filter-check input:checked ~ .tnow-check-mark {
    background: var(--tnow-orange);
    border-color: var(--tnow-orange);
}

.tnow-filter-check input:checked ~ .tnow-check-mark::after {
    content: '‚úì';
    color: #000;
    font-size: 12px;
    font-weight: 700;
}

/* =================================================================
   TABLE
   ================================================================= */
.tnow-admin-table-wrap {
    overflow-x: auto;
    border: 1px solid var(--card-border);
    border-radius: var(--radius-lg);
}

.tnow-admin-table {
    width: 100%;
    border-collapse: collapse;
}

.tnow-admin-table th,
.tnow-admin-table td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid var(--card-border);
}

.tnow-admin-table th {
    background: rgba(255, 255, 255, 0.02);
    font-weight: 600;
    font-size: 0.8rem;
    text-transform: uppercase;
    color: var(--text-muted);
}

.tnow-admin-table tbody tr:hover {
    background: rgba(255, 255, 255, 0.02);
}

.tnow-admin-table tbody tr:last-child td {
    border-bottom: none;
}

.col-image { width: 80px; }
.col-name { min-width: 150px; }
.col-category { width: 120px; }
.col-subject { width: 120px; }
.col-size { width: 80px; }
.col-price { width: 100px; }

.col-status { width: 100px; }
.col-actions { width: 120px; }

/* Style/Subject cells ‚Äî slim mode: one-line compact */
.tnow-tax-compact {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 120px;
}

/* Style/Subject cells ‚Äî large thumb mode: show icons */
.tnow-admin-table.thumb-large .tnow-tax-compact {
    white-space: normal;
    max-width: none;
}
.tnow-tax-icons {
    display: none;
}
.tnow-admin-table.thumb-large .tnow-tax-icons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
    margin-bottom: 0.25rem;
}
.tnow-tax-icon-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.2rem;
    padding: 0.15rem 0.4rem;
    border-radius: 10px;
    background: rgba(255,255,255,0.06);
    font-size: 0.75rem;
    line-height: 1.3;
}
.tnow-tax-icon-tag .tax-emoji {
    font-size: 0.9rem;
}
.tnow-admin-table.thumb-large .tnow-tax-text-only {
    display: none;
}

/* =================================================================
   THUMBNAIL SIZE TOGGLE
   ================================================================= */
.tnow-thumb-toggle {
    display: flex;
    border: 1px solid var(--card-border);
    border-radius: var(--radius-md);
    overflow: hidden;
}

.tnow-thumb-btn {
    padding: 0.5rem 0.75rem;
    background: transparent;
    border: none;
    color: var(--text-muted);
    font-size: 1.1rem;
    cursor: pointer;
    transition: all 0.2s ease;
    line-height: 1;
}

.tnow-thumb-btn:first-child {
    border-right: 1px solid var(--card-border);
}

.tnow-thumb-btn:hover {
    color: var(--tnow-white);
}

.tnow-thumb-btn.active {
    background: var(--tnow-orange);
    color: var(--tnow-black);
}

/* =================================================================
   TABLE IMAGE & FEATURED RIBBON
   ================================================================= */
.tnow-image-wrap {
    position: relative;
    display: inline-block;
}

.tnow-table-image {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: var(--radius-sm);
    background: var(--card-bg);
    transition: all 0.2s ease;
}

/* Large thumbnail mode */
.tnow-admin-table.thumb-large .tnow-table-image {
    width: 200px;
    height: 200px;
}

.tnow-admin-table.thumb-large .col-image {
    width: 120px;
}

.tnow-featured-ribbon {
    position: absolute;
    top: 0;
    left: 0;
    width: 20px;
    height: 100%;
    background: transparent;
    border: none;
    color: var(--card-border);
    font-size: 0.7rem;
    cursor: pointer;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding-top: 4px;
    transition: all 0.2s ease;
    border-radius: var(--radius-sm) 0 0 var(--radius-sm);
}

.tnow-featured-ribbon:hover {
    background: rgba(250, 145, 1, 0.2);
    color: var(--tnow-orange);
}

.tnow-featured-ribbon.is-featured {
    background: var(--tnow-orange);
    color: var(--tnow-black);
}

.tnow-featured-ribbon.is-featured:hover {
    background: var(--tnow-orange-dark);
}

.tnow-table-name {
    font-weight: 600;
    color: var(--tnow-white);
}

.tnow-name-sub {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    margin-top: 0.25rem;
    flex-wrap: wrap;
}

.tnow-table-artist {
    font-size: 0.8rem;
    color: var(--text-muted);
}

.tnow-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    font-weight: 600;
}

.tnow-badge-featured {
    background: rgba(250, 145, 1, 0.2);
    color: var(--tnow-orange);
}

.tnow-badge-available {
    background: rgba(56, 161, 105, 0.2);
    color: var(--tnow-green);
}

.tnow-badge-unavailable {
    background: rgba(229, 62, 62, 0.2);
    color: var(--tnow-red);
}

.tnow-badge-taken {
    background: rgba(139, 0, 0, 0.3);
    color: #ff6b6b;
}

.tnow-badge-flash {
    background: rgba(138, 43, 226, 0.2);
    color: #b19cd9;
}

.tnow-badge-shared {
    background: rgba(59, 130, 246, 0.2);
    color: #7cb3f4;
}

.tnow-badge-pending {
    background: rgba(248, 165, 7, 0.2);
    color: var(--tnow-gold);
}

.tnow-action-btn.approve {
    color: var(--tnow-green);
    border-color: var(--tnow-green);
    font-weight: 700;
}

.tnow-action-btn.approve:hover {
    background: var(--tnow-green);
    color: var(--tnow-black);
}

.tnow-shared-row {
    opacity: 0.75;
}

.tnow-action-btn {
    padding: 0.4rem 0.6rem;
    background: transparent;
    border: 1px solid var(--card-border);
    border-radius: var(--radius-sm);
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s ease;
    margin-right: 0.25rem;
}

.tnow-action-btn:hover {
    border-color: var(--tnow-orange);
    color: var(--tnow-orange);
}

.tnow-action-btn.delete:hover {
    border-color: var(--tnow-red);
    color: var(--tnow-red);
}

/* Clickable edit links */
.tnow-edit-link {
    text-decoration: none;
    color: inherit;
    cursor: pointer;
    transition: opacity 0.2s ease;
}

.tnow-edit-link:hover {
    opacity: 0.8;
}

.tnow-edit-link:hover .tnow-table-name {
    color: var(--tnow-orange);
}

.tnow-edit-link:hover .tnow-table-image {
    border: 2px solid var(--tnow-orange);
}

/* =================================================================
   CATEGORY NAVIGATION
   ================================================================= */
.tnow-category-nav {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    flex-wrap: nowrap;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    scrollbar-color: var(--tnow-orange) transparent;
    padding: 0.75rem 1.25rem;
    background: rgba(0, 3, 33, 0.6);
    border-radius: 0 0 var(--radius-lg) var(--radius-lg);
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-top: 1px solid rgba(255, 255, 255, 0.04);
}

.tnow-cat-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1 1 0;
    padding: 0.75rem 0.5rem;
    background: rgba(255, 255, 255, 0.06);
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: var(--radius-md);
    color: var(--text-muted);
    font-family: var(--font-body);
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 70px;
}

.tnow-cat-btn:hover {
    border-color: var(--tnow-orange);
    color: var(--tnow-white);
}

.tnow-cat-btn.active {
    background: var(--tnow-orange);
    border-color: var(--tnow-orange);
    color: var(--tnow-black);
}

.tnow-cat-icon {
    font-size: 1.25rem;
    margin-bottom: 0.25rem;
}

.tnow-cat-label {
    white-space: nowrap;
    font-weight: 600;
}

.tnow-cat-count {
    font-size: 0.65rem;
    opacity: 0.7;
    margin-top: 0.1rem;
}

.tnow-cat-btn.active .tnow-cat-count {
    opacity: 0.9;
}

/* Slim mode: compact nav buttons ‚Äî one line, no icons */
.tnow-admin.slim-mode .tnow-category-nav {
    gap: 0.3rem;
    padding: 0.4rem 0.75rem;
    margin-bottom: 0.75rem;
}
.tnow-admin.slim-mode .tnow-cat-btn {
    flex-direction: row;
    gap: 0.3rem;
    padding: 0.3rem 0.5rem;
    min-width: auto;
    flex: 0 0 auto;
}
.tnow-admin.slim-mode .tnow-cat-icon {
    display: none;
}
.tnow-admin.slim-mode .tnow-cat-count {
    margin-top: 0;
    opacity: 0.6;
}
.tnow-admin.slim-mode .tnow-cat-count::before {
    content: '(';
}
.tnow-admin.slim-mode .tnow-cat-count::after {
    content: ')';
}
.tnow-admin.slim-mode .tnow-cat-add {
    flex-direction: row;
    padding: 0.3rem 0.5rem;
}

.tnow-cat-add {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.2rem;
    flex: 0 0 auto;
    padding: 0.75rem 0.75rem;
    background: transparent;
    border: 1px dashed rgba(255, 255, 255, 0.2);
    border-radius: var(--radius-md);
    color: var(--text-muted);
    font-family: var(--font-body);
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 50px;
}

.tnow-cat-add:hover {
    border-color: var(--tnow-orange);
    color: var(--tnow-orange);
    background: rgba(250, 145, 1, 0.05);
}

.tnow-approval-note {
    font-size: 0.8rem;
    color: var(--tnow-gold);
    margin-bottom: 1rem;
    padding: 0.5rem 0.75rem;
    background: rgba(248, 165, 7, 0.1);
    border-radius: var(--radius-sm);
    border: 1px solid rgba(248, 165, 7, 0.2);
}

/* =================================================================
   LOADING & STATES
   ================================================================= */
.tnow-admin-loading,
.tnow-admin-error,
.tnow-admin-empty {
    text-align: center;
    padding: 3rem 1rem;
}

.tnow-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--card-border);
    border-top-color: var(--tnow-orange);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 1rem;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.tnow-error-icon,
.tnow-empty-icon {
    font-size: 3rem;
    display: block;
    margin-bottom: 1rem;
}

.tnow-retry-btn {
    padding: 0.75rem 1.5rem;
    background: var(--tnow-orange);
    border: none;
    border-radius: var(--radius-md);
    color: var(--tnow-black);
    font-weight: 700;
    cursor: pointer;
    margin-top: 1rem;
}

/* =================================================================
   MODAL
   ================================================================= */
.tnow-modal {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
}

.tnow-modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.85);
}

.tnow-modal-content {
    position: relative;
    width: 100%;
    max-height: 90vh;
    background: var(--tnow-navy);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-lg);
    overflow-y: auto;
}

.tnow-modal-form {
    max-width: 680px;
    min-height: 520px;
}

.tnow-modal-confirm {
    max-width: 400px;
    padding: 2rem;
    text-align: center;
}

.tnow-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--card-border);
}

.tnow-modal-header h2 {
    margin: 0;
    font-family: var(--font-headline);
    font-size: 1.25rem;
}

/* =================================================================
   HEADER OPTIONS (inline toggles next to title)
   ================================================================= */
/* =================================================================
   CATEGORY PILL PICKER
   ================================================================= */
.tnow-picker-label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.25rem;
    color: var(--tnow-white);
}

.tnow-picker-hint {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin: 0 0 1rem;
}

.tnow-category-picker {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.tnow-cat-pill {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.5rem 0.85rem;
    border: 1px solid var(--card-border);
    border-radius: 20px;
    background: transparent;
    color: var(--text-muted);
    font-family: var(--font-body);
    font-size: 0.8rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.tnow-cat-pill:hover {
    border-color: var(--tnow-orange);
    color: var(--tnow-white);
}

.tnow-cat-pill.active {
    background: rgba(250, 145, 1, 0.15);
    border-color: var(--tnow-orange);
    color: var(--tnow-orange);
    font-weight: 600;
}

.tnow-cat-pill .pill-icon {
    font-size: 1rem;
}

.tnow-cat-pill .pill-check {
    font-size: 0.7rem;
    margin-left: 0.15rem;
}

.tnow-submit-options {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-bottom: 1.25rem;
    padding-bottom: 1.25rem;
    border-bottom: 1px solid var(--card-border);
}

.tnow-toggle {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    cursor: pointer;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-muted);
    padding: 0.4rem 0.7rem;
    border: 1px solid var(--card-border);
    border-radius: var(--radius-md);
    transition: all 0.2s ease;
    white-space: nowrap;
    position: relative;
}

.tnow-toggle:hover {
    border-color: var(--tnow-orange);
    color: var(--tnow-white);
}

.tnow-toggle:has(input:checked) {
    background: rgba(250, 145, 1, 0.15);
    border-color: var(--tnow-orange);
    color: var(--tnow-orange);
}

.tnow-toggle input {
    width: auto;
    margin: 0;
    accent-color: var(--tnow-orange);
}

.tnow-toggle-label {
    pointer-events: none;
}

.tnow-toggle-tip {
    display: none;
    position: absolute;
    bottom: calc(100% + 6px);
    left: 50%;
    transform: translateX(-50%);
    padding: 0.4rem 0.6rem;
    background: var(--tnow-black);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-sm);
    color: var(--tnow-white);
    font-size: 0.7rem;
    font-weight: 400;
    white-space: nowrap;
    pointer-events: none;
    z-index: 10;
}

.tnow-toggle-tip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 5px solid transparent;
    border-top-color: var(--card-border);
}

.tnow-toggle:hover .tnow-toggle-tip {
    display: block;
}

.tnow-modal-close {
    width: 32px;
    height: 32px;
    background: transparent;
    border: 1px solid var(--card-border);
    border-radius: 50%;
    color: var(--tnow-white);
    font-size: 1.25rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.tnow-modal-close:hover {
    background: var(--tnow-orange);
    color: var(--tnow-black);
    border-color: var(--tnow-orange);
}

/* =================================================================
   FORM
   ================================================================= */
.tnow-form {
    padding: 0 1.5rem 1.5rem 1.5rem;
}

.tnow-form-row {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
}

.tnow-form-group {
    flex: 1;
}

.tnow-form-group.full {
    flex: 1 1 100%;
}

.tnow-form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-muted);
}

.tnow-form-group input,
.tnow-form-group select,
.tnow-form-group textarea {
    width: 100%;
    padding: 0.75rem;
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-md);
    color: var(--tnow-white);
    font-family: var(--font-body);
    font-size: 0.9rem;
    outline: none;
    transition: border-color 0.2s ease;
}

.tnow-form-group input:focus,
.tnow-form-group select:focus,
.tnow-form-group textarea:focus {
    border-color: var(--tnow-orange);
}

.tnow-form-group select option {
    background: var(--tnow-navy);
}

.tnow-form-group small {
    display: block;
    margin-top: 0.25rem;
    font-size: 0.75rem;
    color: var(--text-muted);
}

.tnow-form-group.checkbox-group {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 0.25rem;
}

.tnow-checkbox {
    display: flex;
    align-items: center;
    cursor: pointer;
    font-size: 0.9rem;
}

.tnow-checkbox input {
    width: auto;
    margin-right: 0.5rem;
}

/* =================================================================
   INPUT WITH BUTTON (Upload to GHL)
   ================================================================= */
.tnow-input-with-button {
    display: flex;
    gap: 0.5rem;
}

.tnow-input-with-button input {
    flex: 1;
}

.tnow-upload-btn {
    padding: 0.5rem 1rem;
    background: var(--tnow-orange);
    color: var(--tnow-white);
    border: none;
    border-radius: var(--radius-sm);
    font-family: var(--font-body);
    font-weight: 600;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.tnow-upload-btn:hover {
    background: var(--tnow-orange-dark);
}

.tnow-upload-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* =================================================================
   FILE UPLOAD ZONE
   ================================================================= */
.tnow-file-upload {
    position: relative;
    border: 2px dashed var(--card-border);
    border-radius: var(--radius-md);
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
}

.tnow-file-upload:hover,
.tnow-file-upload.dragover {
    border-color: var(--tnow-orange);
    background: rgba(250, 145, 1, 0.05);
}

.tnow-file-upload input[type="file"] {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
}

.tnow-file-upload-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    pointer-events: none;
}

.tnow-upload-icon {
    font-size: 2rem;
}

.tnow-upload-text {
    font-weight: 600;
    color: var(--tnow-white);
}

.tnow-file-upload small {
    color: var(--text-muted);
}

.tnow-file-uploading {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    color: var(--tnow-orange);
}

.tnow-spinner-small {
    width: 20px;
    height: 20px;
    border: 2px solid var(--card-border);
    border-top-color: var(--tnow-orange);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

.tnow-image-preview {
    position: relative;
    display: inline-block;
}

.tnow-remove-image {
    position: absolute;
    top: -8px;
    right: -8px;
    width: 24px;
    height: 24px;
    background: var(--tnow-red);
    border: none;
    border-radius: 50%;
    color: var(--tnow-white);
    font-size: 1rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.tnow-remove-image:hover {
    background: #c53030;
}

.tnow-image-url {
    display: block;
    margin-top: 0.5rem;
    word-break: break-all;
    font-size: 0.7rem;
}

/* =================================================================
   FORM TABS
   ================================================================= */
.tnow-form-tabs {
    display: flex;
    gap: 0;
    margin-bottom: 0;
    border-bottom: none;
    background: rgba(0, 0, 0, 0.3);
    border-radius: var(--radius-md) var(--radius-md) 0 0;
}

.tnow-tab {
    flex: 1;
    padding: 0.875rem 1rem;
    background: transparent;
    border: none;
    border-bottom: 2px solid transparent;
    color: var(--text-muted);
    font-family: var(--font-body);
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.tnow-tab:hover {
    color: var(--tnow-white);
    background: rgba(255, 255, 255, 0.05);
}

.tnow-tab.active {
    color: var(--tnow-orange);
    border-bottom-color: var(--tnow-orange);
    background: rgba(250, 145, 1, 0.1);
}

.tnow-tab-panel {
    display: none;
    padding: 1.5rem;
    border-radius: 0 0 var(--radius-md) var(--radius-md);
}

.tnow-tab-panel.active {
    display: block;
}

/* Tab Panel Contrasting Backgrounds */
#tabImages {
    background: rgba(255, 255, 255, 0.08);
    border-left: 3px solid var(--tnow-orange);
}

#tabDetails {
    background: rgba(0, 3, 33, 0.5);
    border-left: 3px solid var(--tnow-gold);
}

#tabAdvanced {
    background: rgba(56, 161, 105, 0.05);
    border-left: 3px solid var(--tnow-green);
}

/* =================================================================
   IMAGE SECTIONS (Tab 2)
   ================================================================= */
.tnow-image-section {
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--card-border);
}

.tnow-image-section:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
}

.tnow-section-title {
    font-family: var(--font-headline);
    font-size: 1rem;
    margin: 0 0 0.25rem 0;
    color: var(--tnow-white);
}

.tnow-section-hint {
    display: block;
    margin-bottom: 1rem;
    color: var(--text-muted);
    font-size: 0.8rem;
}

.tnow-section-title small {
    font-weight: 400;
    color: var(--text-muted);
    font-size: 0.75rem;
}

/* Slim file upload for line sheet */
.tnow-linesheet-section {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
}

.tnow-file-upload-slim {
    padding: 0.75rem 1rem;
    border-style: dashed;
}

.tnow-file-upload-slim .tnow-file-upload-content {
    flex-direction: row;
    gap: 0;
}

.tnow-file-upload-slim .tnow-upload-text {
    font-size: 0.85rem;
    font-weight: 500;
}

.tnow-image-preview {
    width: 100%;
    max-width: 200px;
    border-radius: var(--radius-md);
    overflow: hidden;
    border: 1px solid var(--card-border);
}

.tnow-image-preview img {
    width: 100%;
    height: auto;
    display: block;
}

.tnow-form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--card-border);
}

.tnow-btn-primary,
.tnow-btn-secondary,
.tnow-btn-danger {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: var(--radius-md);
    font-family: var(--font-body);
    font-weight: 700;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.tnow-btn-primary {
    background: var(--tnow-orange);
    color: var(--tnow-black);
}

.tnow-btn-primary:hover {
    background: var(--tnow-gold);
}

.tnow-btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.tnow-btn-secondary {
    background: transparent;
    border: 1px solid var(--card-border);
    color: var(--tnow-white);
}

.tnow-btn-secondary:hover {
    border-color: var(--tnow-white);
}

.tnow-btn-danger {
    background: var(--tnow-red);
    color: var(--tnow-white);
}

.tnow-btn-danger:hover {
    background: #c53030;
}

.tnow-warning {
    color: var(--tnow-red);
    font-size: 0.85rem;
}

/* =================================================================
   TOAST NOTIFICATIONS
   ================================================================= */
.tnow-toast-container {
    position: fixed;
    bottom: 1rem;
    right: 1rem;
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.tnow-toast {
    padding: 1rem 1.5rem;
    background: var(--tnow-navy);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-md);
    color: var(--tnow-white);
    font-size: 0.9rem;
    animation: slideIn 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.tnow-toast.success {
    border-color: var(--tnow-green);
}

.tnow-toast.error {
    border-color: var(--tnow-red);
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* =================================================================
   PAGE-LEVEL TABS (TattooNOW only)
   ================================================================= */
.tnow-page-tabs {
    display: flex;
    gap: 0;
    margin-bottom: 1.5rem;
    border-bottom: 2px solid var(--card-border);
}

.tnow-page-tab {
    padding: 0.75rem 1.5rem;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    color: var(--text-muted);
    font-family: var(--font-body);
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-bottom: -2px;
}

.tnow-page-tab:hover {
    color: var(--tnow-white);
}

.tnow-page-tab.active {
    color: var(--tnow-orange);
    border-bottom-color: var(--tnow-orange);
}

.tnow-pending-count {
    display: inline-block;
    background: var(--tnow-orange);
    color: var(--tnow-black);
    font-size: 0.7rem;
    font-weight: 700;
    padding: 0.1rem 0.45rem;
    border-radius: 10px;
    margin-left: 0.3rem;
    min-width: 1.2rem;
    text-align: center;
    vertical-align: middle;
}

.tnow-pending-count:empty {
    display: none;
}

/* Community Catalog View */
.tnow-catalog-search {
    position: relative;
    margin-bottom: 1rem;
}
.tnow-catalog-search .tnow-search-input {
    width: 100%;
    box-sizing: border-box;
}
.tnow-catalog-search .tnow-search-icon {
    position: absolute;
    right: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
}
.tnow-catalog-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
}
.tnow-catalog-card {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    overflow: hidden;
    transition: border-color 0.2s;
}
.tnow-catalog-card:hover {
    border-color: var(--tnow-orange);
}
.tnow-catalog-card img {
    width: 100%;
    aspect-ratio: 1;
    object-fit: cover;
    display: block;
}
.tnow-catalog-card-info {
    padding: 0.6rem 0.75rem;
}
.tnow-catalog-card-name {
    font-weight: 600;
    font-size: 0.85rem;
    margin-bottom: 0.25rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.tnow-catalog-card-meta {
    font-size: 0.75rem;
    color: var(--tnow-gray);
    margin-bottom: 0.5rem;
}
.tnow-catalog-btn {
    display: block;
    width: 100%;
    padding: 0.4rem;
    border: none;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    text-align: center;
    transition: background 0.2s;
}
.tnow-catalog-btn.add {
    background: var(--tnow-orange);
    color: #000;
}
.tnow-catalog-btn.add:hover {
    background: var(--tnow-orange-dark);
}
.tnow-catalog-btn.added {
    background: rgba(255,255,255,0.1);
    color: var(--tnow-gray);
}
.tnow-catalog-btn.added:hover {
    background: rgba(220,50,50,0.2);
    color: #e55;
}

.tnow-categories-view {
    padding: 1rem 0;
}

.tnow-categories-loading,
.tnow-categories-empty {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--text-muted);
}

.tnow-categories-empty .tnow-empty-icon {
    font-size: 2.5rem;
    display: block;
    margin-bottom: 0.5rem;
}

.tnow-badge-cat-active {
    background: rgba(56, 161, 105, 0.2);
    color: var(--tnow-green);
    padding: 0.2rem 0.6rem;
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    font-weight: 600;
}

.tnow-badge-cat-pending {
    background: rgba(248, 165, 7, 0.2);
    color: var(--tnow-gold);
    padding: 0.2rem 0.6rem;
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    font-weight: 600;
}

.tnow-cat-section-header td {
    background: rgba(255, 255, 255, 0.04);
    font-weight: 700;
    font-size: 0.85rem;
    color: var(--tnow-white);
    padding: 0.6rem 1rem;
    letter-spacing: 0.02em;
    border-bottom: 2px solid var(--tnow-orange);
}

.tnow-cat-action-btn {
    padding: 0.5rem 1rem;
    border: 1px solid var(--card-border);
    border-radius: var(--radius-sm);
    background: transparent;
    color: var(--tnow-white);
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 600;
    transition: all 0.2s ease;
    margin-right: 0.5rem;
}

.tnow-cat-action-btn.approve {
    color: var(--tnow-green);
    border-color: var(--tnow-green);
}

.tnow-cat-action-btn.approve:hover {
    background: var(--tnow-green);
    color: var(--tnow-black);
}

.tnow-cat-action-btn.reject {
    color: var(--tnow-red);
    border-color: var(--tnow-red);
}

.tnow-cat-action-btn.reject:hover {
    background: var(--tnow-red);
    color: var(--tnow-white);
}

/* =================================================================
   RESPONSIVE
   ================================================================= */
@media (max-width: 768px) {
    .tnow-form-row {
        flex-direction: column;
    }

    .tnow-admin-table th,
    .tnow-admin-table td {
        padding: 0.75rem 0.5rem;
    }

    .col-category,
    .col-subject,
    .col-size,
    .col-price {
        display: none;
    }
}
</style>

<script>
(function() {
    'use strict';

    // =================================================================
    // CONFIGURATION
    // =================================================================

    // Helper to get and persist locationId across pages
    function getLocationId() {
        var storageKey = 'tnow_location_id';
        var urlParam = new URLSearchParams(window.location.search).get('locationId');

        // Priority: window override > URL param > localStorage > GHL merge field
        if (window.TNOW_LOCATION_ID) {
            try { localStorage.setItem(storageKey, window.TNOW_LOCATION_ID); } catch(e) {}
            return window.TNOW_LOCATION_ID;
        }

        if (urlParam) {
            try { localStorage.setItem(storageKey, urlParam); } catch(e) {}
            return urlParam;
        }

        try {
            var stored = localStorage.getItem(storageKey);
            if (stored) return stored;
        } catch(e) {}

        // Fall back to GHL merge field (will be literal string if not in GHL context)
        var ghlId = '{{location.id}}';
        if (ghlId && !ghlId.match(/\{\{.*\}\}/)) {
            try { localStorage.setItem(storageKey, ghlId); } catch(e) {}
            return ghlId;
        }

        return null;
    }

    var CONFIG = {
        apiEndpoint: 'https://tn.reinventingai.com/webhook/5af3d2be-32f0-4d9d-8dfb-fb5053844eb4',
        adminEndpoint: 'https://tn.reinventingai.com/webhook/tattoo-admin-api',
        locationId: getLocationId()
    };

    // =================================================================
    // STATE
    // =================================================================
    var state = {
        designs: [],
        categories: [],
        styles: [],
        subjects: [],
        totalCount: 0,
        searchQuery: '',
        categoryFilter: 'all',
        subjectFilter: 'all',
        sizeFilter: 'all',
        statusFilter: 'all',
        featuredFilter: 'all',
        priceFilter: 'all',
        isLoading: true,
        editingDesign: null,
        deleteDesign: null,
        activeView: 'designs',
        pendingCategories: []
    };

    // =================================================================
    // DOM ELEMENTS
    // =================================================================
    var els = {};

    function cacheDOMElements() {
        els.loading = document.getElementById('adminLoading');
        els.error = document.getElementById('adminError');
        els.errorMessage = document.getElementById('errorMessage');
        els.tableWrap = document.getElementById('adminTableWrap');
        els.tableBody = document.getElementById('adminTableBody');
        els.empty = document.getElementById('adminEmpty');
        els.search = document.getElementById('adminSearch');
        els.categoryNav = document.getElementById('categoryNav');
        els.subjectNav = document.getElementById('subjectNav');
        els.toolbar = document.querySelector('.tnow-admin-toolbar');
        els.sizeFilter = document.getElementById('sizeFilter');
        els.statusFilter = document.getElementById('statusFilter');
        els.featuredCheckbox = document.getElementById('featuredCheckbox');
        els.priceFilter = document.getElementById('priceFilter');
        els.modal = document.getElementById('adminModal');
        els.modalTitle = document.getElementById('modalTitle');
        els.form = document.getElementById('designForm');
        els.saveBtn = document.getElementById('saveBtn');
        els.deleteModal = document.getElementById('deleteModal');
        els.deleteName = document.getElementById('deleteName');
        els.imageInput = document.getElementById('designImage');
        els.imagePreview = document.getElementById('imagePreview');
        els.imagePreviewRow = document.getElementById('imagePreviewRow');
        els.toastContainer = document.getElementById('toastContainer');
    }

    // =================================================================
    // API CALLS
    // =================================================================
    function fetchData() {
        setLoading(true);

        var categoriesUrl = CONFIG.apiEndpoint + '?action=categories';
        // Admin fetches all records with large limit for full management view
        var designsUrl = CONFIG.apiEndpoint + '?action=designs&locationId=' + encodeURIComponent(CONFIG.locationId) + '&limit=1000';

        // Fetch categories first (not location-specific, shared across all locations)
        fetch(categoriesUrl)
            .then(function(r) { return r.json(); })
            .then(function(categoriesRes) {
                if (categoriesRes.success) {
                    state.categories = categoriesRes.categories || [];
                } else {
                    console.warn('Categories fetch returned error, using empty array');
                    state.categories = [];
                }
                // Split into styles and subjects by type
                splitCategories();
                // Always render category UI even if designs fail
                renderCategoryNav();
                renderCategoryPicker();
                renderSubjectNav();
                renderSubjectPicker();
            })
            .catch(function(err) {
                console.error('Categories fetch error:', err);
                state.categories = [];
                splitCategories();
                renderCategoryNav();
                renderCategoryPicker();
                renderSubjectNav();
                renderSubjectPicker();
            });

        // Fetch designs separately (location-specific)
        fetch(designsUrl)
            .then(function(r) { return r.json(); })
            .then(function(designsRes) {
                if (designsRes.success) {
                    state.designs = designsRes.designs || [];
                    state.totalCount = designsRes.pagination ? designsRes.pagination.total : state.designs.length;
                } else {
                    // No designs for this location is OK - just show empty state
                    console.log('No designs found for location, showing empty state');
                    state.designs = [];
                    state.totalCount = 0;
                }
                renderCategoryNav(); // Re-render with counts after designs load
                renderSubjectNav();
                renderTable();
                setLoading(false);
            })
            .catch(function(err) {
                console.error('Designs fetch error:', err);
                state.designs = [];
                state.totalCount = 0;
                renderTable();
                setLoading(false);
            });
    }

    function saveDesignAPI(data) {
        var isEdit = !!data.id;
        var payload = Object.assign({}, data, {
            action: isEdit ? 'updateDesign' : 'createDesign'
        });

        return fetch(CONFIG.adminEndpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(function(r) {
            if (!r.ok) {
                throw new Error('Server error: ' + r.status);
            }
            return r.text().then(function(text) {
                if (!text) {
                    throw new Error('Empty response from server');
                }
                try {
                    return JSON.parse(text);
                } catch (e) {
                    throw new Error('Invalid JSON response: ' + text.substring(0, 100));
                }
            });
        });
    }

    function deleteDesignAPI(id) {
        return fetch(CONFIG.adminEndpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'deleteDesign', id: id })
        })
        .then(function(r) {
            if (!r.ok) {
                throw new Error('Server error: ' + r.status);
            }
            return r.text().then(function(text) {
                if (!text) {
                    throw new Error('Empty response from server');
                }
                try {
                    return JSON.parse(text);
                } catch (e) {
                    throw new Error('Invalid JSON response');
                }
            });
        });
    }

    // =================================================================
    // RENDERING
    // =================================================================
    function splitCategories() {
        state.styles = state.categories.filter(function(c) { return c.type !== 'subject'; });
        state.subjects = state.categories.filter(function(c) { return c.type === 'subject'; });
    }

    var SHORT_NAMES = {
        'Traditional': 'Trad',
        'Japanese': 'Jap',
        'Blackwork': 'Black',
        'Realism': 'Real',
        'Neo-Traditional': 'Neo-Trad',
        'Geometric': 'Geo',
        'Biomechanical': 'Bio',
        'Illustrative': 'Illust',
        'Black & Grey': 'B&G',
        'Minimalist': 'Minimal',
        'Cyber Sigilism': 'Cyber',
        'Trash Polka': 'Trash P'
    };

    function getCategoryCounts() {
        var counts = {};
        state.designs.forEach(function(d) {
            var cats = d.categoryIds || (d.categoryId ? [d.categoryId] : []);
            cats.forEach(function(catId) {
                counts[catId] = (counts[catId] || 0) + 1;
            });
        });
        return counts;
    }

    function renderCategoryNav() {
        var counts = getCategoryCounts();
        var totalCount = state.designs.length;
        var html = '<button class="tnow-cat-btn' + (state.categoryFilter === 'all' ? ' active' : '') + '" data-category="all">' +
                   '<span class="tnow-cat-icon">üé®</span>' +
                   '<span class="tnow-cat-label">All Styles</span>' +
                   '<span class="tnow-cat-count">' + totalCount + '</span>' +
                   '</button>';
        state.styles.forEach(function(cat) {
            var count = counts[cat.id] || 0;
            if (count === 0) return; // Hide empty styles
            var isActive = state.categoryFilter === cat.id;
            var label = SHORT_NAMES[cat.name] || cat.name;
            html += '<button class="tnow-cat-btn' + (isActive ? ' active' : '') + '" data-category="' + cat.id + '" title="' + escapeHtml(cat.name) + ' (' + count + ')">' +
                    '<span class="tnow-cat-icon">' + (cat.icon || 'üé®') + '</span>' +
                    '<span class="tnow-cat-label">' + escapeHtml(label) + '</span>' +
                    '<span class="tnow-cat-count">' + count + '</span>' +
                    '</button>';
        });
        html += '<button class="tnow-cat-add" onclick="TattooAdmin.openAddCategory()" title="Request new style"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><circle cx="7" cy="7" r="1"/></svg> +</button>';
        els.categoryNav.innerHTML = html;
        bindCategoryNav();
    }

    function bindCategoryNav() {
        var buttons = els.categoryNav.querySelectorAll('.tnow-cat-btn');
        buttons.forEach(function(btn) {
            btn.addEventListener('click', function() {
                state.categoryFilter = this.getAttribute('data-category');
                buttons.forEach(function(b) { b.classList.remove('active'); });
                this.classList.add('active');
                renderTable();
            });
        });
    }

    function renderCategoryPicker(selectedIds) {
        var picker = document.getElementById('categoryPicker');
        if (!picker) return;
        selectedIds = selectedIds || [];
        var html = '';
        state.styles.forEach(function(cat) {
            var isActive = selectedIds.indexOf(cat.id) !== -1;
            html += '<button type="button" class="tnow-cat-pill' + (isActive ? ' active' : '') + '" data-cat-id="' + cat.id + '" onclick="TattooAdmin.toggleCatPill(this)">' +
                '<span class="pill-icon">' + (cat.icon || 'üé®') + '</span>' +
                '<span>' + escapeHtml(cat.name) + '</span>' +
                (isActive ? '<span class="pill-check">‚úì</span>' : '') +
                '</button>';
        });
        picker.innerHTML = html;
    }

    function toggleCatPill(btn) {
        btn.classList.toggle('active');
        var check = btn.querySelector('.pill-check');
        if (btn.classList.contains('active')) {
            if (!check) {
                var span = document.createElement('span');
                span.className = 'pill-check';
                span.textContent = '‚úì';
                btn.appendChild(span);
            }
        } else {
            if (check) check.remove();
        }
    }

    function getSelectedCategoryIds() {
        var pills = document.querySelectorAll('#categoryPicker .tnow-cat-pill.active');
        var ids = [];
        pills.forEach(function(p) { ids.push(p.getAttribute('data-cat-id')); });
        return ids;
    }

    // =================================================================
    // SUBJECT NAV & PICKER
    // =================================================================
    function getSubjectCounts() {
        var counts = {};
        state.designs.forEach(function(d) {
            var subs = d.subjectIds || [];
            subs.forEach(function(subId) {
                counts[subId] = (counts[subId] || 0) + 1;
            });
        });
        return counts;
    }

    function renderSubjectNav() {
        if (!els.subjectNav) return;
        var counts = getSubjectCounts();
        var totalCount = state.designs.length;
        var html = '<button class="tnow-cat-btn' + (state.subjectFilter === 'all' ? ' active' : '') + '" data-subject="all">' +
                   '<span class="tnow-cat-icon">üè∑Ô∏è</span>' +
                   '<span class="tnow-cat-label">All Subjects</span>' +
                   '<span class="tnow-cat-count">' + totalCount + '</span>' +
                   '</button>';
        state.subjects.forEach(function(sub) {
            var count = counts[sub.id] || 0;
            if (count === 0) return;
            var isActive = state.subjectFilter === sub.id;
            html += '<button class="tnow-cat-btn' + (isActive ? ' active' : '') + '" data-subject="' + sub.id + '" title="' + escapeHtml(sub.name) + ' (' + count + ')">' +
                    '<span class="tnow-cat-icon">' + (sub.icon || 'üè∑Ô∏è') + '</span>' +
                    '<span class="tnow-cat-label">' + escapeHtml(sub.name) + '</span>' +
                    '<span class="tnow-cat-count">' + count + '</span>' +
                    '</button>';
        });
        html += '<button class="tnow-cat-add" onclick="TattooAdmin.openAddSubject()" title="Request new subject"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><circle cx="7" cy="7" r="1"/></svg> +</button>';
        els.subjectNav.innerHTML = html;
        bindSubjectNav();
    }

    function bindSubjectNav() {
        var buttons = els.subjectNav.querySelectorAll('.tnow-cat-btn');
        buttons.forEach(function(btn) {
            btn.addEventListener('click', function() {
                state.subjectFilter = this.getAttribute('data-subject');
                buttons.forEach(function(b) { b.classList.remove('active'); });
                this.classList.add('active');
                renderTable();
            });
        });
    }

    function renderSubjectPicker(selectedIds) {
        var picker = document.getElementById('subjectPicker');
        if (!picker) return;
        selectedIds = selectedIds || [];
        var html = '';
        state.subjects.forEach(function(sub) {
            var isActive = selectedIds.indexOf(sub.id) !== -1;
            html += '<button type="button" class="tnow-cat-pill' + (isActive ? ' active' : '') + '" data-sub-id="' + sub.id + '" onclick="TattooAdmin.toggleSubPill(this)">' +
                '<span class="pill-icon">' + (sub.icon || 'üè∑Ô∏è') + '</span>' +
                '<span>' + escapeHtml(sub.name) + '</span>' +
                (isActive ? '<span class="pill-check">‚úì</span>' : '') +
                '</button>';
        });
        picker.innerHTML = html;
    }

    function toggleSubPill(btn) {
        btn.classList.toggle('active');
        var check = btn.querySelector('.pill-check');
        if (btn.classList.contains('active')) {
            if (!check) {
                var span = document.createElement('span');
                span.className = 'pill-check';
                span.textContent = '‚úì';
                btn.appendChild(span);
            }
        } else {
            if (check) check.remove();
        }
    }

    function getSelectedSubjectIds() {
        var pills = document.querySelectorAll('#subjectPicker .tnow-cat-pill.active');
        var ids = [];
        pills.forEach(function(p) { ids.push(p.getAttribute('data-sub-id')); });
        return ids;
    }

    var isTattooNOW = CONFIG.locationId === 'dWlb0GcHLhNYv9zAChVt';

    function getStyleInfo(d) {
        var allIds = d.categoryIds || (d.categoryId ? [d.categoryId] : []);
        var styleMap = {};
        state.styles.forEach(function(s) { styleMap[s.id] = s; });
        var matches = allIds.map(function(id) { return styleMap[id]; }).filter(Boolean);
        if (matches.length === 0 && d.styleNames && d.styleNames.length) {
            return { text: d.styleNames.filter(Boolean).join(', '), items: [] };
        }
        return { text: matches.map(function(s) { return s.name; }).join(', '), items: matches };
    }

    function getSubjectInfo(d) {
        var allIds = d.categoryIds || (d.categoryId ? [d.categoryId] : []);
        var subMap = {};
        state.subjects.forEach(function(s) { subMap[s.id] = s; });
        var matches = allIds.map(function(id) { return subMap[id]; }).filter(Boolean);
        if (matches.length === 0 && d.subjectNames && d.subjectNames.length) {
            return { text: d.subjectNames.filter(Boolean).join(', '), items: [] };
        }
        return { text: matches.map(function(s) { return s.name; }).join(', '), items: matches };
    }

    function renderTaxCell(info, fallback) {
        if (!info.text) return escapeHtml(fallback || '-');
        var iconHtml = '';
        if (info.items.length > 0) {
            iconHtml = '<div class="tnow-tax-icons">';
            info.items.forEach(function(item) {
                iconHtml += '<span class="tnow-tax-icon-tag"><span class="tax-emoji">' + (item.icon || 'üé®') + '</span> ' + escapeHtml(item.name) + '</span>';
            });
            iconHtml += '</div>';
        }
        return '<div class="tnow-tax-compact">' + iconHtml + '<span class="tnow-tax-text-only">' + escapeHtml(info.text) + '</span></div>';
    }

    function renderTable() {
        var filtered = filterDesigns();

        if (filtered.length === 0) {
            els.tableWrap.style.display = 'none';
            els.empty.style.display = 'block';
            return;
        }

        els.empty.style.display = 'none';
        els.tableWrap.style.display = 'block';

        var html = '';
        filtered.forEach(function(d) {
            var isShared = d.locationId && d.locationId !== CONFIG.locationId;
            html += '<tr data-id="' + d.id + '"' + (isShared ? ' class="tnow-shared-row"' : '') + '>' +
                '<td class="col-image">' +
                    '<div class="tnow-image-wrap">' +
                    (isShared
                        ? '<span class="tnow-edit-link">' + (d.image ? '<img src="' + escapeHtml(d.thumbnail || d.image) + '" class="tnow-table-image" alt="">' : '<span class="tnow-table-image">üé®</span>') + '</span>'
                        : '<a href="javascript:void(0)" class="tnow-edit-link" onclick="TattooAdmin.openEdit(\'' + d.id + '\')">' + (d.image ? '<img src="' + escapeHtml(d.thumbnail || d.image) + '" class="tnow-table-image" alt="">' : '<span class="tnow-table-image">üé®</span>') + '</a>'
                    ) +
                    '<button class="tnow-featured-ribbon' + (d.featured ? ' is-featured' : '') + '" onclick="TattooAdmin.toggleFeatured(\'' + d.id + '\')" title="' + (d.featured ? 'Remove from featured' : 'Mark as featured') + '">‚òÖ</button>' +
                    '</div>' +
                '</td>' +
                '<td class="col-name">' +
                    (isShared
                        ? '<div class="tnow-table-name">' + escapeHtml(d.name) + '</div>'
                        : '<a href="javascript:void(0)" class="tnow-edit-link" onclick="TattooAdmin.openEdit(\'' + d.id + '\')">' + '<div class="tnow-table-name">' + escapeHtml(d.name) + '</div>' + '</a>'
                    ) +
                    '<div class="tnow-name-sub">' +
                        (d.artist ? '<span class="tnow-table-artist">' + escapeHtml(d.artist) + '</span>' : '') +
                        (isShared ? '<span class="tnow-badge tnow-badge-shared">Shared</span> ' : '') +
                        (d.sharePending ? '<span class="tnow-badge tnow-badge-pending">Pending Share</span> ' : '') +
                        (d.inCommunityCatalog && !isShared ? '<span class="tnow-badge tnow-badge-shared">Shared</span> ' : '') +
                        (d.oneTimeFlash ? '<span class="tnow-badge tnow-badge-flash">1x Design</span> ' : '') +
                        (d.status === 'Taken' && d.oneTimeFlash ? '<span class="tnow-badge tnow-badge-taken">Taken</span> ' : '') +
                    '</div>' +
                '</td>' +
                '<td class="col-category">' + renderTaxCell(getStyleInfo(d), 'Uncategorized') + '</td>' +
                '<td class="col-subject">' + renderTaxCell(getSubjectInfo(d), '-') + '</td>' +
                '<td class="col-size">' + escapeHtml(d.sizeEstimate || '-') + '</td>' +
                '<td class="col-price">' + escapeHtml(d.priceRange || '-') + '</td>' +

                '<td class="col-status">' +
                    (d.available !== false ? '<span class="tnow-badge tnow-badge-available">Active</span>' : '<span class="tnow-badge tnow-badge-unavailable">Inactive</span>') +
                '</td>' +
                '<td class="col-actions">' +
                    (d.sharePending && isTattooNOW ? '<button class="tnow-action-btn approve" onclick="TattooAdmin.approveShare(\'' + d.id + '\')" title="Approve share">‚úì</button>' : '') +
                    (isShared
                        ? '<button class="tnow-action-btn delete" onclick="TattooAdmin.openDelete(\'' + d.id + '\')" title="Remove from catalog">‚úñ</button>'
                        : '<button class="tnow-action-btn" onclick="TattooAdmin.openEdit(\'' + d.id + '\')" title="Edit">‚úèÔ∏è</button>' +
                          '<button class="tnow-action-btn delete" onclick="TattooAdmin.openDelete(\'' + d.id + '\')" title="Delete">üóëÔ∏è</button>'
                    ) +
                '</td>' +
            '</tr>';
        });

        els.tableBody.innerHTML = html;
    }

    function filterDesigns() {
        var filtered = state.designs;

        // Style filter
        if (state.categoryFilter !== 'all') {
            filtered = filtered.filter(function(d) {
                var cats = d.categoryIds || (d.categoryId ? [d.categoryId] : []);
                return cats.indexOf(state.categoryFilter) !== -1;
            });
        }

        // Subject filter
        if (state.subjectFilter !== 'all') {
            filtered = filtered.filter(function(d) {
                var cats = d.categoryIds || (d.categoryId ? [d.categoryId] : []);
                return cats.indexOf(state.subjectFilter) !== -1;
            });
        }

        // Size filter
        if (state.sizeFilter !== 'all') {
            filtered = filtered.filter(function(d) {
                return d.sizeEstimate === state.sizeFilter;
            });
        }

        // Status filter (available/unavailable)
        if (state.statusFilter !== 'all') {
            filtered = filtered.filter(function(d) {
                if (state.statusFilter === 'available') {
                    return d.available !== false;
                } else {
                    return d.available === false;
                }
            });
        }

        // Featured filter
        if (state.featuredFilter !== 'all') {
            filtered = filtered.filter(function(d) {
                if (state.featuredFilter === 'featured') {
                    return d.featured === true;
                } else {
                    return d.featured !== true;
                }
            });
        }

        // Price filter
        if (state.priceFilter !== 'all') {
            filtered = filtered.filter(function(d) {
                var minPrice = extractMinPrice(d.priceRange);
                if (minPrice === null) return false;
                switch (state.priceFilter) {
                    case 'under500': return minPrice < 500;
                    case '500to1000': return minPrice >= 500 && minPrice < 1000;
                    case '1000to2000': return minPrice >= 1000 && minPrice < 2000;
                    case 'over2000': return minPrice >= 2000;
                    default: return true;
                }
            });
        }

        // Search filter
        if (state.searchQuery) {
            var q = state.searchQuery.toLowerCase();
            filtered = filtered.filter(function(d) {
                return (d.name && d.name.toLowerCase().indexOf(q) > -1) ||
                       (d.description && d.description.toLowerCase().indexOf(q) > -1) ||
                       (d.artist && d.artist.toLowerCase().indexOf(q) > -1);
            });
        }

        return filtered;
    }

    // =================================================================
    // MODAL HANDLERS
    // =================================================================
    function openAdd() {
        state.editingDesign = null;
        els.modalTitle.textContent = 'Add Design';
        els.saveBtn.textContent = 'Add Design';
        els.form.reset();
        document.getElementById('designId').value = '';
        document.getElementById('designLineSheet').value = '';
        document.getElementById('designBodyPart').value = '';
        document.getElementById('designAvailable').checked = true;
        document.getElementById('designOneTimeFlash').checked = false;
        document.getElementById('designCommunity').checked = false;
        els.imagePreviewRow.style.display = 'none';
        // Reset design image upload zone
        document.getElementById('fileUploadZone').style.display = 'block';
        document.getElementById('uploadContent').style.display = 'flex';
        document.getElementById('uploadingState').style.display = 'none';
        document.getElementById('designImageFile').value = '';
        // Reset line sheet upload zone
        document.getElementById('lineSheetUploadZone').style.display = 'block';
        document.getElementById('lineSheetUploadContent').style.display = 'flex';
        document.getElementById('lineSheetUploadingState').style.display = 'none';
        document.getElementById('lineSheetPreviewRow').style.display = 'none';
        document.getElementById('lineSheetFile').value = '';
        renderCategoryPicker([]); // Reset style pills
        renderSubjectPicker([]); // Reset subject pills
        switchTab('images'); // Reset to first tab
        els.modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    function openEdit(id) {
        var design = state.designs.find(function(d) { return d.id === id; });
        if (!design) return;

        state.editingDesign = design;
        els.modalTitle.textContent = 'Edit Design';
        els.saveBtn.textContent = 'Save Changes';

        document.getElementById('designId').value = design.id;
        document.getElementById('designName').value = design.name || '';
        // Split categoryIds into style and subject IDs
        var allIds = design.categoryIds || (design.categoryId ? [design.categoryId] : []);
        var styleIdSet = {};
        state.styles.forEach(function(s) { styleIdSet[s.id] = true; });
        var subjectIdSet = {};
        state.subjects.forEach(function(s) { subjectIdSet[s.id] = true; });
        var styleIds = allIds.filter(function(id) { return styleIdSet[id]; });
        var subjectIds = allIds.filter(function(id) { return subjectIdSet[id]; });
        renderCategoryPicker(styleIds);
        renderSubjectPicker(subjectIds);
        document.getElementById('designArtist').value = design.artist || '';
        document.getElementById('designImage').value = design.image || '';
        document.getElementById('designDescription').value = design.description || '';
        document.getElementById('designSize').value = design.sizeEstimate || '';
        document.getElementById('designTime').value = design.timeEstimate || '';
        document.getElementById('designPrice').value = design.priceRange || '';
        document.getElementById('designSort').value = design.sortOrder || '';
        document.getElementById('designLineSheet').value = design.lineSheet || '';
        document.getElementById('designBodyPart').value = design.bodyPart || '';
        document.getElementById('designFeatured').checked = design.featured || false;
        document.getElementById('designAvailable').checked = design.available !== false;
        document.getElementById('designOneTimeFlash').checked = design.oneTimeFlash || false;
        document.getElementById('designCommunity').checked = design.inCommunityCatalog || design.sharePending || false;

        // Design image preview
        if (design.image) {
            els.imagePreview.src = design.image;
            document.getElementById('imageUrlDisplay').textContent = design.image;
            els.imagePreviewRow.style.display = 'block';
            document.getElementById('fileUploadZone').style.display = 'none';
        } else {
            els.imagePreviewRow.style.display = 'none';
            document.getElementById('fileUploadZone').style.display = 'block';
        }
        // Reset design image upload state
        document.getElementById('uploadContent').style.display = 'flex';
        document.getElementById('uploadingState').style.display = 'none';
        document.getElementById('designImageFile').value = '';

        // Line sheet preview
        if (design.lineSheet) {
            document.getElementById('lineSheetPreview').src = design.lineSheet;
            document.getElementById('lineSheetUrlDisplay').textContent = design.lineSheet;
            document.getElementById('lineSheetPreviewRow').style.display = 'block';
            document.getElementById('lineSheetUploadZone').style.display = 'none';
        } else {
            document.getElementById('lineSheetPreviewRow').style.display = 'none';
            document.getElementById('lineSheetUploadZone').style.display = 'block';
        }
        // Reset line sheet upload state
        document.getElementById('lineSheetUploadContent').style.display = 'flex';
        document.getElementById('lineSheetUploadingState').style.display = 'none';
        document.getElementById('lineSheetFile').value = '';

        switchTab('images'); // Reset to first tab
        els.modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        els.modal.style.display = 'none';
        document.body.style.overflow = '';
        state.editingDesign = null;
        // Reset to first tab when closing
        switchTab('images');
    }

    function openDelete(id) {
        var design = state.designs.find(function(d) { return d.id === id; });
        if (!design) return;

        state.deleteDesign = design;
        var isShared = design.locationId && design.locationId !== CONFIG.locationId;
        els.deleteName.textContent = design.name;

        if (isShared) {
            document.getElementById('deleteTitle').textContent = 'Remove Shared Design?';
            document.getElementById('deleteMessage').innerHTML = 'Remove "<span id="deleteName">' + escapeHtml(design.name) + '</span>" from your gallery?';
            document.getElementById('deleteWarning').textContent = 'You can re-add it from the Community Catalog anytime.';
            document.getElementById('deleteConfirmBtn').textContent = 'Remove';
        } else {
            document.getElementById('deleteTitle').textContent = 'Delete Design?';
            document.getElementById('deleteMessage').innerHTML = 'Are you sure you want to delete "<span id="deleteName">' + escapeHtml(design.name) + '</span>"?';
            document.getElementById('deleteWarning').textContent = 'This action cannot be undone.';
            document.getElementById('deleteConfirmBtn').textContent = 'Delete';
        }

        els.deleteModal.style.display = 'flex';
    }

    function closeDeleteModal() {
        els.deleteModal.style.display = 'none';
        state.deleteDesign = null;
    }

    // =================================================================
    // FILE UPLOAD TO GHL
    // =================================================================
    function handleFileSelect(event, type) {
        var file = event.target.files[0];
        if (!file) return;

        // Default to 'design' if type not specified
        type = type || 'design';

        // Validate file type
        if (!file.type.startsWith('image/')) {
            showToast('Please select an image file', 'error');
            return;
        }

        // Validate file size (10MB max)
        if (file.size > 10 * 1024 * 1024) {
            showToast('Image must be under 10MB', 'error');
            return;
        }

        uploadFileToGHL(file, type);
    }

    function uploadFileToGHL(file, type) {
        // Get elements based on upload type
        var isLineSheet = type === 'linesheet';
        var uploadContent = document.getElementById(isLineSheet ? 'lineSheetUploadContent' : 'uploadContent');
        var uploadingState = document.getElementById(isLineSheet ? 'lineSheetUploadingState' : 'uploadingState');
        var fileInput = document.getElementById(isLineSheet ? 'lineSheetFile' : 'designImageFile');

        // Show uploading state
        uploadContent.style.display = 'none';
        uploadingState.style.display = 'flex';
        fileInput.disabled = true;

        // Convert file to base64 for API
        var reader = new FileReader();
        reader.onload = function(e) {
            var base64Data = e.target.result;

            // GHL API key is now stored in the n8n workflow - no need to pass from client
            fetch(CONFIG.adminEndpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'uploadImage',
                    fileData: base64Data,
                    fileName: file.name,
                    fileType: file.type,
                    locationId: CONFIG.locationId
                })
            })
            .then(function(r) {
                // Check if response is ok before parsing JSON
                if (!r.ok && r.status !== 200) {
                    throw new Error('Server error: ' + r.status);
                }
                return r.json();
            })
            .then(function(result) {
                if (result.success && result.url) {
                    if (isLineSheet) {
                        // Line sheet upload
                        document.getElementById('designLineSheet').value = result.url;
                        document.getElementById('lineSheetPreview').src = result.url;
                        document.getElementById('lineSheetUrlDisplay').textContent = result.url;
                        document.getElementById('lineSheetPreviewRow').style.display = 'block';
                        document.getElementById('lineSheetUploadZone').style.display = 'none';
                        showToast('Line sheet uploaded!', 'success');
                    } else {
                        // Design image upload
                        document.getElementById('designImage').value = result.url;
                        els.imagePreview.src = result.url;
                        document.getElementById('imageUrlDisplay').textContent = result.url;
                        els.imagePreviewRow.style.display = 'block';
                        document.getElementById('fileUploadZone').style.display = 'none';
                        showToast('Image uploaded!', 'success');
                    }
                } else {
                    throw new Error(result.error || 'Upload failed');
                }
            })
            .catch(function(err) {
                showToast('Error: ' + err.message, 'error');
                // Reset upload zone
                uploadContent.style.display = 'flex';
                uploadingState.style.display = 'none';
            })
            .finally(function() {
                fileInput.disabled = false;
                fileInput.value = '';
            });
        };
        reader.readAsDataURL(file);
    }

    function removeImage(type) {
        type = type || 'design';
        var isLineSheet = type === 'linesheet';

        if (isLineSheet) {
            document.getElementById('designLineSheet').value = '';
            document.getElementById('lineSheetPreview').src = '';
            document.getElementById('lineSheetUrlDisplay').textContent = '';
            document.getElementById('lineSheetPreviewRow').style.display = 'none';
            document.getElementById('lineSheetUploadZone').style.display = 'block';
            document.getElementById('lineSheetUploadContent').style.display = 'flex';
            document.getElementById('lineSheetUploadingState').style.display = 'none';
        } else {
            document.getElementById('designImage').value = '';
            els.imagePreview.src = '';
            document.getElementById('imageUrlDisplay').textContent = '';
            els.imagePreviewRow.style.display = 'none';
            document.getElementById('fileUploadZone').style.display = 'block';
            document.getElementById('uploadContent').style.display = 'flex';
            document.getElementById('uploadingState').style.display = 'none';
        }
    }

    // =================================================================
    // FORM HANDLING
    // =================================================================
    function saveDesign(e) {
        e.preventDefault();

        // Validate required fields
        var image = document.getElementById('designImage').value;
        var name = document.getElementById('designName').value;
        var categoryIds = getSelectedCategoryIds();
        var subjectIds = getSelectedSubjectIds();

        if (!image) {
            showToast('Please upload a design image', 'error');
            switchTab('images');
            return;
        }

        if (!name) {
            showToast('Please fill in design name', 'error');
            switchTab('details');
            return;
        }

        if (categoryIds.length === 0) {
            showToast('Please select at least one style', 'error');
            switchTab('categories');
            return;
        }

        var wantsShare = document.getElementById('designCommunity').checked;

        var data = {
            id: document.getElementById('designId').value || null,
            name: name,
            categoryIds: categoryIds,
            subjectIds: subjectIds,
            artist: document.getElementById('designArtist').value,
            image: image,
            description: document.getElementById('designDescription').value,
            sizeEstimate: document.getElementById('designSize').value,
            timeEstimate: document.getElementById('designTime').value,
            priceRange: document.getElementById('designPrice').value,
            sortOrder: parseInt(document.getElementById('designSort').value) || 999,
            lineSheet: document.getElementById('designLineSheet').value,
            bodyPart: document.getElementById('designBodyPart').value,
            featured: document.getElementById('designFeatured').checked,
            available: document.getElementById('designAvailable').checked,
            oneTimeFlash: document.getElementById('designOneTimeFlash').checked,
            inCommunityCatalog: isTattooNOW ? wantsShare : (state.editingDesign ? state.editingDesign.inCommunityCatalog || false : false),
            sharePending: isTattooNOW ? false : wantsShare,
            locationId: CONFIG.locationId
        };

        els.saveBtn.disabled = true;
        els.saveBtn.textContent = 'Saving...';

        saveDesignAPI(data)
            .then(function(result) {
                if (result.success) {
                    showToast(data.id ? 'Design updated!' : 'Design added!', 'success');
                    closeModal();
                    fetchData();
                } else {
                    throw new Error(result.error || 'Failed to save');
                }
            })
            .catch(function(err) {
                showToast('Error: ' + err.message, 'error');
            })
            .finally(function() {
                els.saveBtn.disabled = false;
                els.saveBtn.textContent = data.id ? 'Save Changes' : 'Add Design';
            });
    }

    function confirmDelete() {
        if (!state.deleteDesign) return;

        var design = state.deleteDesign;
        var isShared = design.locationId && design.locationId !== CONFIG.locationId;

        if (isShared) {
            // Unsubscribe: remove this location from the design's subscribers
            fetch(CONFIG.adminEndpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'unsubscribeDesign', designId: design.id, locationId: CONFIG.locationId })
            })
                .then(function(r) { return r.json(); })
                .then(function(result) {
                    if (result.success) {
                        showToast('Design removed from your gallery', 'success');
                        closeDeleteModal();
                        fetchData();
                    } else {
                        throw new Error(result.error || 'Failed to remove');
                    }
                })
                .catch(function(err) {
                    showToast('Error: ' + err.message, 'error');
                });
        } else {
            deleteDesignAPI(design.id)
                .then(function(result) {
                    if (result.success) {
                        showToast('Design deleted!', 'success');
                        closeDeleteModal();
                        fetchData();
                    } else {
                        throw new Error(result.error || 'Failed to delete');
                    }
                })
                .catch(function(err) {
                    showToast('Error: ' + err.message, 'error');
                });
        }
    }

    // =================================================================
    // STATE HELPERS
    // =================================================================
    function setLoading(isLoading) {
        state.isLoading = isLoading;
        els.loading.style.display = isLoading ? 'block' : 'none';
        if (isLoading) {
            els.tableWrap.style.display = 'none';
            els.empty.style.display = 'none';
            els.error.style.display = 'none';
        }
    }

    function showError(message) {
        els.loading.style.display = 'none';
        els.tableWrap.style.display = 'none';
        els.empty.style.display = 'none';
        els.errorMessage.textContent = message || 'Unable to load designs.';
        els.error.style.display = 'block';
    }

    function showToast(message, type) {
        var toast = document.createElement('div');
        toast.className = 'tnow-toast ' + (type || '');
        toast.textContent = message;
        els.toastContainer.appendChild(toast);

        setTimeout(function() {
            toast.remove();
        }, 3000);
    }

    function extractMinPrice(priceRange) {
        if (!priceRange) return null;
        var match = priceRange.match(/\$?([\d,]+)/);
        if (match) {
            return parseInt(match[1].replace(/,/g, ''), 10);
        }
        return null;
    }

    // =================================================================
    // EVENT BINDING
    // =================================================================
    function bindEvents() {
        // Search
        els.search.addEventListener('input', function(e) {
            state.searchQuery = e.target.value.trim();
            renderTable();
        });

        // Category navigation is bound in renderCategoryNav()

        // Size filter
        els.sizeFilter.addEventListener('change', function(e) {
            state.sizeFilter = e.target.value;
            renderTable();
        });

        // Status filter
        els.statusFilter.addEventListener('change', function(e) {
            state.statusFilter = e.target.value;
            renderTable();
        });

        // Featured filter checkbox
        els.featuredCheckbox.addEventListener('change', function(e) {
            state.featuredFilter = e.target.checked ? 'featured' : 'all';
            renderTable();
        });

        // Price filter
        els.priceFilter.addEventListener('change', function(e) {
            state.priceFilter = e.target.value;
            renderTable();
        });

        // Image URL preview
        els.imageInput.addEventListener('blur', function(e) {
            var url = e.target.value.trim();
            if (url) {
                els.imagePreview.src = url;
                els.imagePreviewRow.style.display = 'block';
            } else {
                els.imagePreviewRow.style.display = 'none';
            }
        });

        // Escape key closes modals
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (els.modal.style.display !== 'none') closeModal();
                if (els.deleteModal.style.display !== 'none') closeDeleteModal();
            }
        });
    }

    // =================================================================
    // UTILITIES
    // =================================================================
    function escapeHtml(text) {
        if (!text) return '';
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // =================================================================
    // PUBLIC API
    // =================================================================
    // =================================================================
    // TAB SWITCHING
    // =================================================================
    var tabOrder = ['images', 'categories', 'subjects', 'details', 'advanced'];
    var currentTabIndex = 0;

    function switchTab(tabName) {
        // Map tab names to panel IDs
        var tabPanelMap = {
            'images': 'tabImages',
            'categories': 'tabCategories',
            'subjects': 'tabSubjects',
            'details': 'tabDetails',
            'advanced': 'tabAdvanced'
        };

        // Update current tab index
        currentTabIndex = tabOrder.indexOf(tabName);
        if (currentTabIndex === -1) currentTabIndex = 0;

        // Update tab buttons
        document.querySelectorAll('.tnow-tab').forEach(function(tab) {
            tab.classList.toggle('active', tab.getAttribute('data-tab') === tabName);
        });

        // Update tab panels
        document.querySelectorAll('.tnow-tab-panel').forEach(function(panel) {
            panel.classList.toggle('active', panel.id === tabPanelMap[tabName]);
        });

        // Update button visibility (Next vs Save)
        var nextBtn = document.getElementById('nextBtn');
        var saveBtn = document.getElementById('saveBtn');
        if (currentTabIndex < tabOrder.length - 1) {
            nextBtn.style.display = 'inline-block';
            saveBtn.style.display = 'none';
        } else {
            nextBtn.style.display = 'none';
            saveBtn.style.display = 'inline-block';
        }
    }

    function nextTab() {
        if (currentTabIndex < tabOrder.length - 1) {
            switchTab(tabOrder[currentTabIndex + 1]);
        }
    }

    function resetTabs() {
        switchTab('images');
    }

    // =================================================================
    // TOGGLE FEATURED FROM LIST
    // =================================================================
    function toggleFeatured(id) {
        var design = state.designs.find(function(d) { return d.id === id; });
        if (!design) return;

        var newFeatured = !design.featured;
        var data = {
            id: design.id,
            featured: newFeatured,
            action: 'updateDesign'
        };

        fetch(CONFIG.adminEndpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(function(r) { return r.json(); })
        .then(function(result) {
            if (result.success) {
                design.featured = newFeatured;
                renderTable();
                showToast(newFeatured ? 'Design featured!' : 'Removed from featured', 'success');
            } else {
                throw new Error(result.error || 'Failed to update');
            }
        })
        .catch(function(err) {
            showToast('Error: ' + err.message, 'error');
        });
    }

    // =================================================================
    // THUMBNAIL SIZE TOGGLE
    // =================================================================
    function setThumbSize(size) {
        var table = document.getElementById('adminTable');
        var admin = document.getElementById('tattooAdmin');
        if (size === 'large') {
            table.classList.add('thumb-large');
            admin.classList.remove('slim-mode');
        } else {
            table.classList.remove('thumb-large');
            admin.classList.add('slim-mode');
        }
        // Update toggle buttons
        document.querySelectorAll('.tnow-thumb-btn').forEach(function(btn) {
            btn.classList.toggle('active', btn.getAttribute('data-size') === size);
        });
    }

    // =================================================================
    // APPROVE SHARE
    // =================================================================
    function approveShare(id) {
        var design = state.designs.find(function(d) { return d.id === id; });
        if (!design) return;

        saveDesignAPI({
            id: design.id,
            name: design.name || '',
            categoryId: design.categoryId || '',
            description: design.description || '',
            artist: design.artist || '',
            image: design.image || '',
            sizeEstimate: design.sizeEstimate || '',
            timeEstimate: design.timeEstimate || '',
            priceRange: design.priceRange || '',
            locationId: design.locationId || '',
            featured: design.featured || false,
            available: design.available !== false,
            sortOrder: design.sortOrder || 999,
            oneTimeFlash: design.oneTimeFlash || false,
            inCommunityCatalog: true,
            sharePending: false,
            lineSheet: design.lineSheet || '',
            bodyPart: design.bodyPart || ''
        })
        .then(function(result) {
            if (result.success) {
                showToast('Share approved for "' + design.name + '"', 'success');
                fetchData();
            } else {
                throw new Error(result.error || 'Failed to approve');
            }
        })
        .catch(function(err) {
            showToast('Error: ' + err.message, 'error');
        });
    }

    // =================================================================
    // ADD CATEGORY
    // =================================================================
    function openAddCategory() {
        state.editingCategory = null;
        state.addingType = 'style';
        document.getElementById('newCatName').value = '';
        document.getElementById('newCatIcon').value = '';
        var modal = document.getElementById('addCategoryModal');
        modal.querySelector('h3').textContent = 'Request New Style';
        modal.querySelector('.tnow-approval-note').textContent = 'New styles require TattooNOW approval before going live.';
        modal.querySelector('.tnow-approval-note').style.display = '';
        var saveBtn = document.getElementById('saveCatBtn');
        saveBtn.textContent = 'Submit Request';
        saveBtn.onclick = function() { saveCategory(); };
        modal.style.display = 'flex';
    }

    function openAddSubject() {
        state.editingCategory = null;
        state.addingType = 'subject';
        document.getElementById('newCatName').value = '';
        document.getElementById('newCatIcon').value = '';
        var modal = document.getElementById('addCategoryModal');
        modal.querySelector('h3').textContent = 'Request New Subject';
        modal.querySelector('.tnow-approval-note').textContent = 'New subjects require TattooNOW approval before going live.';
        modal.querySelector('.tnow-approval-note').style.display = '';
        var saveBtn = document.getElementById('saveCatBtn');
        saveBtn.textContent = 'Submit Request';
        saveBtn.onclick = function() { saveCategory(); };
        modal.style.display = 'flex';
    }

    function closeAddCategory() {
        state.editingCategory = null;
        document.getElementById('addCategoryModal').style.display = 'none';
    }

    function saveCategory() {
        var name = document.getElementById('newCatName').value.trim();
        if (!name) {
            showToast('Please enter a category name', 'error');
            return;
        }

        var icon = document.getElementById('newCatIcon').value.trim() || 'üé®';
        var slug = name.toLowerCase().replace(/[&]/g, 'and').replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
        var maxSort = 0;
        state.categories.forEach(function(c) {
            if (c.sortOrder > maxSort) maxSort = c.sortOrder;
        });

        var btn = document.getElementById('saveCatBtn');
        btn.disabled = true;
        btn.textContent = 'Adding...';

        var catType = state.addingType || 'style';
        fetch(CONFIG.adminEndpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'createCategory',
                name: name,
                slug: slug,
                icon: icon,
                sortOrder: maxSort + 1,
                type: catType
            })
        })
        .then(function(r) { return r.json(); })
        .then(function(result) {
            if (result.success) {
                var label = catType === 'subject' ? 'Subject' : 'Style';
                showToast(label + ' "' + name + '" submitted for approval!', 'success');
                closeAddCategory();
            } else {
                throw new Error(result.error || 'Failed to submit category');
            }
        })
        .catch(function(err) {
            showToast('Error: ' + err.message, 'error');
        })
        .finally(function() {
            btn.disabled = false;
            btn.textContent = 'Add Category';
        });
    }

    // =================================================================
    // CATEGORY APPROVAL (TattooNOW only)
    // =================================================================
    function switchView(view) {
        state.activeView = view;
        var tabs = document.querySelectorAll('.tnow-page-tab');
        tabs.forEach(function(t) { t.classList.toggle('active', t.getAttribute('data-view') === view); });

        var categoriesView = document.getElementById('categoriesView');
        var catalogView = document.getElementById('catalogView');
        var headerBtn = document.getElementById('headerActionBtn');

        // Hide all views first
        els.tableWrap.style.display = 'none';
        els.empty.style.display = 'none';
        els.loading.style.display = 'none';
        els.error.style.display = 'none';
        els.toolbar.style.display = 'none';
        els.categoryNav.style.display = 'none';
        els.subjectNav.style.display = 'none';
        categoriesView.style.display = 'none';
        catalogView.style.display = 'none';

        if (view === 'designs') {
            els.toolbar.style.display = '';
            els.categoryNav.style.display = '';
            els.subjectNav.style.display = '';
            headerBtn.textContent = '+ Add Design';
            headerBtn.onclick = function() { TattooAdmin.openAdd(); };
            renderTable();
        } else if (view === 'catalog') {
            catalogView.style.display = 'block';
            headerBtn.style.display = 'none';
            fetchCatalog();
        } else {
            categoriesView.style.display = 'block';
            headerBtn.textContent = '+ Add Category';
            headerBtn.onclick = function() { TattooAdmin.openAddCategory(); };
            fetchCategoriesView();
        }

        if (view !== 'catalog') {
            headerBtn.style.display = '';
        }
    }

    function fetchCategoriesView() {
        var loadingEl = document.getElementById('categoriesLoading');
        var emptyEl = document.getElementById('categoriesEmpty');
        var tableWrap = document.getElementById('categoriesTableWrap');

        loadingEl.style.display = 'block';
        emptyEl.style.display = 'none';
        tableWrap.style.display = 'none';

        // Fetch both active and pending categories
        var activeFetch = fetch(CONFIG.apiEndpoint + '?action=categories').then(function(r) { return r.json(); });
        var pendingFetch = fetch(CONFIG.apiEndpoint + '?action=pendingCategories').then(function(r) { return r.json(); });

        Promise.all([activeFetch, pendingFetch])
            .then(function(results) {
                loadingEl.style.display = 'none';
                state.categories = results[0].success ? results[0].categories || [] : [];
                state.pendingCategories = results[1].success ? results[1].categories || [] : [];
                renderCategoriesView();
                updatePendingCount();
            })
            .catch(function(err) {
                loadingEl.style.display = 'none';
                console.error('Categories fetch error:', err);
                renderCategoriesView();
            });
    }

    function fetchPendingCategories() {
        fetch(CONFIG.apiEndpoint + '?action=pendingCategories')
            .then(function(r) { return r.json(); })
            .then(function(res) {
                state.pendingCategories = res.success ? res.categories || [] : [];
                updatePendingCount();
            })
            .catch(function() {
                state.pendingCategories = [];
                updatePendingCount();
            });
    }

    function renderCategoriesView() {
        var emptyEl = document.getElementById('categoriesEmpty');
        var tableWrap = document.getElementById('categoriesTableWrap');
        var tbody = document.getElementById('categoriesTableBody');

        var allCats = [];

        // Pending first (needs attention)
        state.pendingCategories.forEach(function(cat) {
            allCats.push({ id: cat.id, name: cat.name, slug: cat.slug, icon: cat.icon, sortOrder: cat.sortOrder, type: cat.type || 'style', pending: true });
        });

        // Active categories sorted by sortOrder (styles first, then subjects)
        var sorted = state.categories.slice().sort(function(a, b) {
            return (a.sortOrder || 999) - (b.sortOrder || 999);
        });
        sorted.forEach(function(cat) {
            allCats.push({ id: cat.id, name: cat.name, slug: cat.slug, icon: cat.icon, sortOrder: cat.sortOrder, type: cat.type || 'style', pending: false });
        });

        if (allCats.length === 0) {
            emptyEl.style.display = 'block';
            tableWrap.style.display = 'none';
            return;
        }

        emptyEl.style.display = 'none';
        tableWrap.style.display = 'block';

        // Separate into styles and subjects
        var styleRows = allCats.filter(function(c) { return c.type !== 'subject'; });
        var subjectRows = allCats.filter(function(c) { return c.type === 'subject'; });

        function renderCatRow(cat) {
            var safeName = escapeHtml(cat.name).replace(/'/g, "\\'");
            var typeLabel = cat.type === 'subject' ? 'Subject' : 'Style';
            var row = '<tr>' +
                '<td style="font-size:1.5rem;text-align:center;">' + escapeHtml(cat.icon || 'üé®') + '</td>' +
                '<td><strong>' + escapeHtml(cat.name) + '</strong></td>' +
                '<td style="color:var(--text-muted);">' + escapeHtml(cat.slug || '') + '</td>' +
                '<td style="color:var(--text-muted);">' + typeLabel + '</td>' +
                '<td>';
            if (cat.pending) {
                row += '<span class="tnow-badge-cat-pending">Pending</span>';
            } else {
                row += '<span class="tnow-badge-cat-active">Active</span>';
            }
            row += '</td><td>';
            if (cat.pending) {
                row += '<button class="tnow-cat-action-btn approve" onclick="TattooAdmin.approveCat(\'' + cat.id + '\', \'' + safeName + '\')">Approve</button>' +
                    '<button class="tnow-cat-action-btn reject" onclick="TattooAdmin.rejectCat(\'' + cat.id + '\', \'' + safeName + '\')">Reject</button>';
            } else {
                row += '<button class="tnow-cat-action-btn" onclick="TattooAdmin.editCat(\'' + cat.id + '\')">Edit</button>';
            }
            row += '</td></tr>';
            return row;
        }

        var html = '';
        // Styles section header
        if (styleRows.length > 0) {
            html += '<tr class="tnow-cat-section-header"><td colspan="6">üé® Styles (' + styleRows.length + ')</td></tr>';
            styleRows.forEach(function(cat) { html += renderCatRow(cat); });
        }
        // Subjects section header
        if (subjectRows.length > 0) {
            html += '<tr class="tnow-cat-section-header"><td colspan="6">üè∑Ô∏è Subjects (' + subjectRows.length + ')</td></tr>';
            subjectRows.forEach(function(cat) { html += renderCatRow(cat); });
        }
        tbody.innerHTML = html;
    }

    function updatePendingCount() {
        var badge = document.getElementById('pendingCount');
        if (badge) {
            badge.textContent = state.pendingCategories.length > 0 ? state.pendingCategories.length : '';
        }
    }

    function editCat(id) {
        var cat = state.categories.find(function(c) { return c.id === id; });
        if (!cat) return;

        state.editingCategory = cat;
        document.getElementById('newCatName').value = cat.name || '';
        document.getElementById('newCatIcon').value = cat.icon || '';

        var modal = document.getElementById('addCategoryModal');
        modal.querySelector('h3').textContent = 'Edit Category';
        modal.querySelector('.tnow-approval-note').style.display = 'none';
        var saveBtn = document.getElementById('saveCatBtn');
        saveBtn.textContent = 'Save';
        saveBtn.onclick = function() { saveEditCategory(); };
        modal.style.display = 'flex';
    }

    function saveEditCategory() {
        var cat = state.editingCategory;
        if (!cat) return;

        var name = document.getElementById('newCatName').value.trim();
        if (!name) { showToast('Please enter a category name', 'error'); return; }

        var icon = document.getElementById('newCatIcon').value.trim();
        var slug = name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
        var btn = document.getElementById('saveCatBtn');
        btn.disabled = true;
        btn.textContent = 'Saving...';

        fetch(CONFIG.adminEndpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'updateCategory', id: cat.id, name: name, icon: icon, slug: slug })
        })
        .then(function(r) { return r.json(); })
        .then(function(result) {
            if (result.success) {
                showToast('Category "' + name + '" updated!', 'success');
                closeAddCategory();
                fetchCategoriesView();
                fetchData(); // Refresh category nav in designs view
            } else {
                throw new Error(result.error || 'Failed to update');
            }
        })
        .catch(function(err) {
            showToast('Error: ' + err.message, 'error');
        })
        .finally(function() {
            btn.disabled = false;
            btn.textContent = 'Save';
        });
    }

    function approveCat(id, name) {
        fetch(CONFIG.adminEndpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'approveCategory', id: id })
        })
        .then(function(r) { return r.json(); })
        .then(function(result) {
            if (result.success) {
                showToast('Category "' + name + '" approved!', 'success');
                fetchCategoriesView();
                fetchData(); // Refresh category nav
            } else {
                throw new Error(result.error || 'Failed to approve');
            }
        })
        .catch(function(err) {
            showToast('Error: ' + err.message, 'error');
        });
    }

    function rejectCat(id, name) {
        if (!confirm('Reject and delete category "' + name + '"? This cannot be undone.')) return;

        fetch(CONFIG.adminEndpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'rejectCategory', id: id })
        })
        .then(function(r) { return r.json(); })
        .then(function(result) {
            if (result.success) {
                showToast('Category "' + name + '" rejected.', 'success');
                fetchCategoriesView();
            } else {
                throw new Error(result.error || 'Failed to reject');
            }
        })
        .catch(function(err) {
            showToast('Error: ' + err.message, 'error');
        });
    }

    // =================================================================
    // COMMUNITY CATALOG
    // =================================================================
    var catalogDesigns = [];

    function fetchCatalog() {
        var loadingEl = document.getElementById('catalogLoading');
        var emptyEl = document.getElementById('catalogEmpty');
        var gridEl = document.getElementById('catalogGrid');

        loadingEl.style.display = 'block';
        emptyEl.style.display = 'none';
        gridEl.innerHTML = '';

        fetch(CONFIG.apiEndpoint + '?action=catalog')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                loadingEl.style.display = 'none';
                catalogDesigns = (data.designs || []);
                if (catalogDesigns.length === 0) {
                    emptyEl.style.display = 'block';
                } else {
                    renderCatalog();
                }
            })
            .catch(function(err) {
                loadingEl.style.display = 'none';
                emptyEl.style.display = 'block';
                emptyEl.querySelector('p').textContent = 'Error loading catalog: ' + err.message;
            });
    }

    function renderCatalog() {
        var gridEl = document.getElementById('catalogGrid');
        var emptyEl = document.getElementById('catalogEmpty');
        var searchVal = (document.getElementById('catalogSearch').value || '').toLowerCase();
        var filtered = catalogDesigns.filter(function(d) {
            if (!searchVal) return true;
            return (d.name || '').toLowerCase().indexOf(searchVal) !== -1 ||
                   (d.categoryName || '').toLowerCase().indexOf(searchVal) !== -1 ||
                   (d.artist || '').toLowerCase().indexOf(searchVal) !== -1;
        });

        if (filtered.length === 0) {
            gridEl.innerHTML = '';
            emptyEl.style.display = 'block';
            return;
        }
        emptyEl.style.display = 'none';

        var locId = CONFIG.locationId;
        var html = '';
        filtered.forEach(function(d) {
            var subs = d.subscribedLocations || '';
            var isAdded = subs.indexOf(',' + locId + ',') !== -1;
            html += '<div class="tnow-catalog-card" data-id="' + d.id + '">' +
                '<img src="' + (d.thumbnail || d.image || '') + '" alt="' + (d.name || '') + '" loading="lazy">' +
                '<div class="tnow-catalog-card-info">' +
                    '<div class="tnow-catalog-card-name">' + (d.name || 'Untitled') + '</div>' +
                    '<div class="tnow-catalog-card-meta">' + (d.categoryName || '') + (d.artist ? ' &bull; ' + d.artist : '') + '</div>' +
                    '<button class="tnow-catalog-btn ' + (isAdded ? 'added' : 'add') + '" ' +
                        'onclick="TattooAdmin.toggleCatalogDesign(\'' + d.id + '\', ' + (isAdded ? 'false' : 'true') + ')">' +
                        (isAdded ? 'Added' : '+ Add') +
                    '</button>' +
                '</div>' +
            '</div>';
        });
        gridEl.innerHTML = html;
    }

    function filterCatalog() {
        renderCatalog();
    }

    function toggleCatalogDesign(designId, subscribe) {
        var action = subscribe ? 'subscribeDesign' : 'unsubscribeDesign';
        var btn = document.querySelector('.tnow-catalog-card[data-id="' + designId + '"] .tnow-catalog-btn');
        if (btn) {
            btn.disabled = true;
            btn.textContent = subscribe ? 'Adding...' : 'Removing...';
        }

        fetch(CONFIG.adminEndpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: action, designId: designId, locationId: CONFIG.locationId })
        })
        .then(function(r) { return r.json(); })
        .then(function(result) {
            if (result.success) {
                // Update local data
                var design = catalogDesigns.find(function(d) { return d.id === designId; });
                if (design) design.subscribedLocations = result.subscribedLocations || '';
                renderCatalog();
                showToast(subscribe ? 'Design added to your gallery' : 'Design removed from your gallery', 'success');
            } else {
                throw new Error(result.error || 'Failed');
            }
        })
        .catch(function(err) {
            showToast('Error: ' + err.message, 'error');
            if (btn) { btn.disabled = false; btn.textContent = subscribe ? '+ Add' : 'Added'; }
        });
    }

    window.TattooAdmin = {
        refresh: fetchData,
        openAdd: openAdd,
        openEdit: openEdit,
        closeModal: closeModal,
        openDelete: openDelete,
        closeDeleteModal: closeDeleteModal,
        confirmDelete: confirmDelete,
        saveDesign: saveDesign,
        switchTab: switchTab,
        nextTab: nextTab,
        handleFileSelect: handleFileSelect,
        removeImage: removeImage,
        toggleFeatured: toggleFeatured,
        setThumbSize: setThumbSize,
        approveShare: approveShare,
        openAddCategory: openAddCategory,
        openAddSubject: openAddSubject,
        closeAddCategory: closeAddCategory,
        saveCategory: saveCategory,
        switchView: switchView,
        approveCat: approveCat,
        rejectCat: rejectCat,
        editCat: editCat,
        toggleCatPill: toggleCatPill,
        toggleSubPill: toggleSubPill,
        filterCatalog: filterCatalog,
        toggleCatalogDesign: toggleCatalogDesign,
        getState: function() { return state; }
    };

    // =================================================================
    // INITIALIZE
    // =================================================================
    function init() {
        cacheDOMElements();
        bindEvents();
        fetchData();

        // Show page tabs for all locations
        document.getElementById('pageTabs').style.display = 'flex';
        if (isTattooNOW) {
            document.getElementById('tabCatalog').style.display = 'none';
            fetchPendingCategories();
        } else {
            document.getElementById('tabCategories').style.display = 'none';
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
</script>
