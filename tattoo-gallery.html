<!--
=================================================================
TATTOO DESIGN GALLERY
=================================================================
Self-contained HTML/CSS/JS for GHL Custom Code element.
Fetches tattoo designs from Airtable via n8n webhook proxy.
Displays designs by category with modal detail view and booking.

Configuration:
- Set window.TNOW_LOCATION_ID before this script, OR
- Pass ?locationId=XXX in the URL

Requires: n8n workflow "Tattoo Gallery API Proxy" to be active
with Airtable credentials configured.
=================================================================
-->

<div class="tnow-gallery" id="tattooGallery">
    <!-- Dev Banner -->
    <div style="background:#ff4444;color:#fff;text-align:center;padding:8px;font-family:sans-serif;font-weight:bold;font-size:1.1rem;">DEV BRANCH - TEST MODE</div>
    <!-- Search & Filters -->
    <div class="tnow-filters-wrap" id="galleryFilters">
        <div class="tnow-search-wrap">
            <input type="text" class="tnow-search-input" id="searchInput" placeholder="Search designs..." autocomplete="off">
            <span class="tnow-search-icon">üîç</span>
            <button class="tnow-search-clear" id="searchClear" style="display:none;">&times;</button>
        </div>
        <div class="tnow-filter-row">
            <label class="tnow-filter-check" id="featuredFilter">
                <input type="checkbox" id="featuredCheckbox">
                <span class="tnow-check-mark"></span>
                <span>Featured</span>
            </label>
            <select class="tnow-filter-select" id="sizeFilter">
                <option value="all">All Sizes</option>
                <option value="Small">Small</option>
                <option value="Medium">Medium</option>
                <option value="Large">Large</option>
                <option value="XL">XL</option>
            </select>
            <select class="tnow-filter-select" id="priceFilter">
                <option value="all">All Prices</option>
                <option value="under500">Under $500</option>
                <option value="500to1000">$500 - $1,000</option>
                <option value="1000to2000">$1,000 - $2,000</option>
                <option value="over2000">Over $2,000</option>
            </select>
        </div>
    </div>

    <!-- Category Navigation -->
    <div class="tnow-gallery-nav" id="galleryNav">
        <button class="tnow-cat-btn" data-category="all" data-active="true">
            <span class="tnow-cat-icon">‚ú®</span>
            <span class="tnow-cat-label">All</span>
        </button>
        <!-- Dynamic category buttons + "More" link inserted here -->
    </div>

    <!-- Loading State -->
    <div class="tnow-gallery-loading" id="galleryLoading">
        <div class="tnow-skeleton-grid">
            <div class="tnow-skeleton-card"></div>
            <div class="tnow-skeleton-card"></div>
            <div class="tnow-skeleton-card"></div>
            <div class="tnow-skeleton-card"></div>
            <div class="tnow-skeleton-card"></div>
            <div class="tnow-skeleton-card"></div>
            <div class="tnow-skeleton-card"></div>
            <div class="tnow-skeleton-card"></div>
        </div>
    </div>

    <!-- Error State -->
    <div class="tnow-gallery-error" id="galleryError" style="display:none;">
        <div class="tnow-error-content">
            <span class="tnow-error-icon">‚ö†Ô∏è</span>
            <p>Unable to load designs. Please try again.</p>
            <button class="tnow-retry-btn" onclick="TattooGallery.refresh()">Retry</button>
        </div>
    </div>

    <!-- Empty State -->
    <div class="tnow-gallery-empty" id="galleryEmpty" style="display:none;">
        <div class="tnow-empty-content">
            <span class="tnow-empty-icon" id="emptyIcon">üé®</span>
            <p id="emptyMessage">No designs available in this category.</p>
            <button class="tnow-cat-btn" id="emptyAction" onclick="TattooGallery.filterCategory('all')">View All Designs</button>
        </div>
    </div>

    <!-- Design Grid -->
    <div class="tnow-gallery-grid" id="galleryGrid" style="display:none;"></div>

    <!-- Load More -->
    <div class="tnow-load-more-wrap" id="loadMoreWrap" style="display:none;">
        <p class="tnow-showing-count" id="showingCount"></p>
        <button class="tnow-load-more-btn" id="loadMoreBtn" onclick="TattooGallery.loadMore()">Load More</button>
    </div>

    <!-- Design Detail Modal -->
    <div class="tnow-modal" id="galleryModal" style="display:none;">
        <div class="tnow-modal-backdrop" onclick="TattooGallery.closeModal()"></div>
        <button class="tnow-modal-nav tnow-modal-prev" id="modalPrev" onclick="TattooGallery.navPrev()" aria-label="Previous design">&#8249;</button>
        <button class="tnow-modal-nav tnow-modal-next" id="modalNext" onclick="TattooGallery.navNext()" aria-label="Next design">&#8250;</button>
        <div class="tnow-modal-content">
            <button class="tnow-modal-close" onclick="TattooGallery.closeModal()" aria-label="Close">&times;</button>
            <div class="tnow-modal-body">
                <div class="tnow-modal-image tnow-design-image" oncontextmenu="return false;">
                    <img id="modalImage" src="" alt="" draggable="false">
                    <div class="tnow-watermark-overlay"></div>
                    <div class="tnow-watermark-tiles"></div>
                    <span class="tnow-watermark-logo">TattooNOW</span>
                    <span class="tnow-featured-badge" id="modalFeatured" style="display:none;">Featured</span>
                    <span class="tnow-taken-badge" id="modalTaken" style="display:none;">Taken</span>
                    <span class="tnow-onetime-badge" id="modalOneTime" style="display:none;">1x Design</span>
                </div>
                <div class="tnow-modal-info">
                    <h2 class="tnow-modal-title" id="modalTitle"></h2>
                    <div class="tnow-taken-notice" id="modalTakenNotice" style="display:none;">This design has been claimed and is no longer available.</div>
                    <div class="tnow-onetime-notice" id="modalOneTimeNotice" style="display:none;">This is a one-of-a-kind design meant to be tattooed only once.</div>
                    <p class="tnow-modal-desc" id="modalDescription"></p>
                    <div class="tnow-modal-meta">
                        <div class="tnow-meta-item" id="modalSizeWrap">
                            <span class="tnow-meta-label">Size</span>
                            <span class="tnow-meta-value" id="modalSize"></span>
                        </div>
                        <div class="tnow-meta-item" id="modalTimeWrap">
                            <span class="tnow-meta-label">Est. Time</span>
                            <span class="tnow-meta-value" id="modalTime"></span>
                        </div>
                        <div class="tnow-meta-item" id="modalPriceWrap">
                            <span class="tnow-meta-label">Price Range</span>
                            <span class="tnow-meta-value tnow-price" id="modalPrice"></span>
                        </div>
                        <div class="tnow-meta-item" id="modalBodyPartWrap">
                            <span class="tnow-meta-label">Perfect For</span>
                            <span class="tnow-meta-value" id="modalBodyPart"></span>
                        </div>
                        <div class="tnow-meta-item" id="modalCategoryWrap">
                            <span class="tnow-meta-label">Category</span>
                            <span class="tnow-meta-value" id="modalCategory"></span>
                        </div>
                    </div>
                    <a id="modalBookBtn" href="#" class="tnow-book-btn">Request This Design</a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* =================================================================
   CSS VARIABLES (TattooNOW Brand)
   ================================================================= */
.tnow-gallery {
    --tnow-orange: #fa9101;
    --tnow-orange-dark: #cd7600;
    --tnow-gold: #F8A507;
    --tnow-black: #000000;
    --tnow-navy: #000321;
    --tnow-teal: #81e6d9;
    --tnow-white: #ffffff;
    --tnow-gray: #8893A8;
    --tnow-gray-light: #C9D8E0;

    --card-bg: rgba(255, 255, 255, 0.03);
    --card-border: rgba(255, 255, 255, 0.1);
    --card-hover-border: rgba(250, 145, 1, 0.5);
    --text-muted: #a0a0a0;

    --font-headline: 'Roboto Slab', 'Arial Black', sans-serif;
    --font-body: 'Roboto', Arial, sans-serif;

    --radius-sm: 4px;
    --radius-md: 8px;
    --radius-lg: 12px;

    font-family: var(--font-body);
    color: var(--tnow-white);
}

/* =================================================================
   FILTERS WRAP
   ================================================================= */
.tnow-filters-wrap {
    margin-bottom: 0;
    background: rgba(0, 3, 33, 0.6);
    padding: 1rem 1.25rem;
    border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-bottom: none;
}

.tnow-filters-wrap .tnow-filter-select,
.tnow-filters-wrap .tnow-filter-check,
.tnow-filters-wrap .tnow-search-input {
    background: rgba(255, 255, 255, 0.06);
    border-color: rgba(255, 255, 255, 0.12);
}

.tnow-filter-row {
    display: flex;
    gap: 0.75rem;
    margin-top: 0.75rem;
}

.tnow-filter-select {
    flex: 1;
    padding: 0.75rem 1rem;
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-md);
    color: var(--tnow-white);
    font-family: var(--font-body);
    font-size: 0.9rem;
    outline: none;
    cursor: pointer;
    transition: border-color 0.2s ease;
}

.tnow-filter-select:focus {
    border-color: var(--tnow-orange);
}

.tnow-filter-check {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-md);
    color: var(--tnow-white);
    font-family: var(--font-body);
    font-size: 0.9rem;
    cursor: pointer;
    transition: border-color 0.2s ease;
    white-space: nowrap;
}

.tnow-filter-check:hover {
    border-color: var(--tnow-orange);
}

.tnow-filter-check input {
    display: none;
}

.tnow-check-mark {
    width: 18px;
    height: 18px;
    border: 2px solid var(--card-border);
    border-radius: 4px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

.tnow-filter-check input:checked ~ .tnow-check-mark {
    background: var(--tnow-orange);
    border-color: var(--tnow-orange);
}

.tnow-filter-check input:checked ~ .tnow-check-mark::after {
    content: '‚úì';
    color: #000;
    font-size: 12px;
    font-weight: 700;
}

.tnow-filter-select option {
    background: var(--tnow-navy);
}

/* =================================================================
   SEARCH BOX
   ================================================================= */
.tnow-search-wrap {
    position: relative;
}

.tnow-search-input {
    width: 100%;
    padding: 0.875rem 3rem 0.875rem 2.75rem;
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-md);
    color: var(--tnow-white);
    font-family: var(--font-body);
    font-size: 1rem;
    outline: none;
    transition: all 0.2s ease;
}

.tnow-search-input::placeholder {
    color: var(--text-muted);
}

.tnow-search-input:focus {
    border-color: var(--tnow-orange);
    background: rgba(250, 145, 1, 0.05);
}

.tnow-search-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    font-size: 1rem;
    pointer-events: none;
}

.tnow-search-clear {
    position: absolute;
    right: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    width: 28px;
    height: 28px;
    background: var(--card-border);
    border: none;
    border-radius: 50%;
    color: var(--tnow-white);
    font-size: 1.2rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.tnow-search-clear:hover {
    background: var(--tnow-orange);
    color: var(--tnow-black);
}

/* =================================================================
   CATEGORY NAVIGATION
   ================================================================= */
.tnow-gallery-nav {
    display: flex;
    gap: 10px;
    padding: 0.75rem 1.25rem;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    scrollbar-color: var(--tnow-orange) transparent;
    background: rgba(0, 3, 33, 0.6);
    border-radius: 0 0 var(--radius-lg) var(--radius-lg);
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-top: 1px solid rgba(255, 255, 255, 0.04);
    margin-bottom: 1.5rem;
}

.tnow-gallery-nav::-webkit-scrollbar {
    height: 4px;
}

.tnow-gallery-nav::-webkit-scrollbar-thumb {
    background: var(--tnow-orange);
    border-radius: 2px;
}

.tnow-cat-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 0.6rem 1rem;
    background: transparent;
    border: 1px solid var(--card-border);
    border-radius: var(--radius-md);
    color: var(--text-muted);
    font-family: var(--font-body);
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.tnow-cat-btn:hover {
    border-color: #444;
    background: rgba(255, 255, 255, 0.03);
}

.tnow-cat-btn[data-active="true"] {
    border-color: var(--tnow-orange);
    background: rgba(250, 145, 1, 0.15);
    color: var(--tnow-orange);
}

.tnow-cat-icon {
    font-size: 1.1rem;
}

/* More Link (to categories page) */
.tnow-more-link {
    text-decoration: none;
}

.tnow-more-link[data-active="true"] {
    border-color: var(--tnow-orange);
    background: rgba(250, 145, 1, 0.15);
    color: var(--tnow-orange);
}

/* =================================================================
   LOADING STATE (Skeleton)
   ================================================================= */
.tnow-skeleton-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    padding: 1rem 0;
}

.tnow-skeleton-card {
    aspect-ratio: 3/4;
    background: linear-gradient(90deg, var(--card-bg) 25%, rgba(255,255,255,0.08) 50%, var(--card-bg) 75%);
    background-size: 200% 100%;
    animation: skeleton-shimmer 1.5s infinite;
    border-radius: var(--radius-lg);
}

@keyframes skeleton-shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

/* =================================================================
   ERROR & EMPTY STATES
   ================================================================= */
.tnow-gallery-error,
.tnow-gallery-empty {
    padding: 3rem 1rem;
    text-align: center;
}

.tnow-error-content,
.tnow-empty-content {
    max-width: 300px;
    margin: 0 auto;
}

.tnow-error-icon,
.tnow-empty-icon {
    font-size: 3rem;
    display: block;
    margin-bottom: 1rem;
}

.tnow-error-content p,
.tnow-empty-content p {
    color: var(--text-muted);
    margin-bottom: 1.5rem;
}

.tnow-retry-btn {
    padding: 0.75rem 1.5rem;
    background: var(--tnow-orange);
    border: none;
    border-radius: var(--radius-md);
    color: var(--tnow-black);
    font-family: var(--font-body);
    font-weight: 700;
    font-size: 0.9rem;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s ease;
}

.tnow-retry-btn:hover {
    background: var(--tnow-gold);
    transform: translateY(-1px);
}

/* =================================================================
   DESIGN GRID
   ================================================================= */
.tnow-gallery-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    padding: 1rem 0;
}

a.tnow-design-card {
    text-decoration: none;
    color: inherit;
    display: block;
}

.tnow-design-card {
    position: relative;
    border-radius: var(--radius-lg);
    overflow: hidden;
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    cursor: pointer;
    transition: all 0.3s ease;
}

.tnow-design-card:hover {
    border-color: var(--card-hover-border);
    transform: translateY(-4px);
    box-shadow: 0 8px 30px rgba(250, 145, 1, 0.15);
}

.tnow-design-image {
    position: relative;
    aspect-ratio: 3/4;
    overflow: hidden;
    background: var(--tnow-navy);
    /* Image protection */
    user-select: none;
    -webkit-user-select: none;
    -webkit-touch-callout: none;
}

.tnow-design-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.4s ease;
    /* Prevent drag */
    -webkit-user-drag: none;
    pointer-events: none;
}

/* =================================================================
   IMAGE PROTECTION OVERLAY
   ================================================================= */
.tnow-watermark-overlay {
    position: absolute;
    inset: 0;
    pointer-events: none;
    z-index: 2;
    /* Subtle diagonal stripe pattern */
    background: repeating-linear-gradient(
        45deg,
        transparent,
        transparent 40px,
        rgba(250, 145, 1, 0.02) 40px,
        rgba(250, 145, 1, 0.02) 80px
    );
}

.tnow-watermark-logo {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 1.5rem;
    font-weight: 700;
    font-family: var(--font-headline);
    color: rgba(255, 255, 255, 0.08);
    text-transform: uppercase;
    letter-spacing: 0.3em;
    white-space: nowrap;
    pointer-events: none;
    z-index: 3;
    animation: watermark-pulse 4s ease-in-out infinite;
}

@keyframes watermark-pulse {
    0%, 100% { opacity: 0.08; transform: translate(-50%, -50%) scale(1); }
    50% { opacity: 0.12; transform: translate(-50%, -50%) scale(1.02); }
}

/* Tiled watermark pattern - very subtle */
.tnow-watermark-tiles {
    position: absolute;
    inset: 0;
    pointer-events: none;
    z-index: 2;
    opacity: 0.03;
    background-image:
        repeating-linear-gradient(
            0deg,
            transparent,
            transparent 100px,
            rgba(250, 145, 1, 0.3) 100px,
            rgba(250, 145, 1, 0.3) 101px
        ),
        repeating-linear-gradient(
            90deg,
            transparent,
            transparent 100px,
            rgba(250, 145, 1, 0.3) 100px,
            rgba(250, 145, 1, 0.3) 101px
        );
}

/* =================================================================
   STRONGER PROTECTION FOR TAKEN DESIGNS
   ================================================================= */
.tnow-design-card.is-taken .tnow-watermark-overlay {
    background: repeating-linear-gradient(
        45deg,
        transparent,
        transparent 30px,
        rgba(139, 0, 0, 0.08) 30px,
        rgba(139, 0, 0, 0.08) 60px
    );
}

.tnow-design-card.is-taken .tnow-watermark-logo {
    color: rgba(255, 100, 100, 0.25);
    font-size: 1.2rem;
    letter-spacing: 0.2em;
    animation: taken-watermark-pulse 3s ease-in-out infinite;
}

@keyframes taken-watermark-pulse {
    0%, 100% { opacity: 0.2; transform: translate(-50%, -50%) scale(1) rotate(-5deg); }
    50% { opacity: 0.35; transform: translate(-50%, -50%) scale(1.05) rotate(5deg); }
}

.tnow-design-card.is-taken .tnow-watermark-tiles {
    opacity: 0.12;
    background-image:
        repeating-linear-gradient(
            0deg,
            transparent,
            transparent 40px,
            rgba(139, 0, 0, 0.4) 40px,
            rgba(139, 0, 0, 0.4) 42px
        ),
        repeating-linear-gradient(
            90deg,
            transparent,
            transparent 40px,
            rgba(139, 0, 0, 0.4) 40px,
            rgba(139, 0, 0, 0.4) 42px
        );
}

/* Add diagonal "TAKEN" text pattern for extra protection */
.tnow-design-card.is-taken .tnow-design-image::after {
    content: '';
    position: absolute;
    inset: 0;
    z-index: 5;
    pointer-events: none;
    background:
        repeating-linear-gradient(
            -45deg,
            transparent,
            transparent 60px,
            rgba(139, 0, 0, 0.06) 60px,
            rgba(139, 0, 0, 0.06) 120px
        );
}

/* Modal taken design protection */
.tnow-modal-image.is-taken .tnow-watermark-overlay {
    background: repeating-linear-gradient(
        45deg,
        transparent,
        transparent 40px,
        rgba(139, 0, 0, 0.1) 40px,
        rgba(139, 0, 0, 0.1) 80px
    );
}

.tnow-modal-image.is-taken .tnow-watermark-logo {
    color: rgba(255, 100, 100, 0.3);
    font-size: 2rem;
    animation: taken-watermark-pulse 3s ease-in-out infinite;
}

.tnow-modal-image.is-taken .tnow-watermark-tiles {
    opacity: 0.15;
    background-image:
        repeating-linear-gradient(
            0deg,
            transparent,
            transparent 50px,
            rgba(139, 0, 0, 0.5) 50px,
            rgba(139, 0, 0, 0.5) 52px
        ),
        repeating-linear-gradient(
            90deg,
            transparent,
            transparent 50px,
            rgba(139, 0, 0, 0.5) 50px,
            rgba(139, 0, 0, 0.5) 52px
        );
}

.tnow-modal-image.is-taken::after {
    content: '';
    position: absolute;
    inset: 0;
    z-index: 5;
    pointer-events: none;
    background:
        repeating-linear-gradient(
            -45deg,
            transparent,
            transparent 80px,
            rgba(139, 0, 0, 0.08) 80px,
            rgba(139, 0, 0, 0.08) 160px
        );
}

.tnow-design-card:hover .tnow-design-image img {
    transform: scale(1.05);
}

.tnow-design-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    color: var(--card-border);
}

.tnow-featured-badge {
    position: absolute;
    top: 12px;
    right: 12px;
    padding: 0.35rem 0.75rem;
    background: var(--tnow-orange);
    color: var(--tnow-black);
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    border-radius: var(--radius-sm);
    letter-spacing: 0.5px;
}

.tnow-taken-badge {
    position: absolute;
    top: 12px;
    left: 12px;
    padding: 0.35rem 0.75rem;
    background: rgba(139, 0, 0, 0.9);
    color: var(--tnow-white);
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    border-radius: var(--radius-sm);
    letter-spacing: 0.5px;
    border: 1px solid rgba(255, 100, 100, 0.3);
}

.tnow-onetime-badge {
    position: absolute;
    top: 12px;
    left: 12px;
    padding: 0.35rem 0.75rem;
    background: rgba(248, 165, 7, 0.9);
    color: var(--tnow-black);
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    border-radius: var(--radius-sm);
    letter-spacing: 0.5px;
    border: 1px solid rgba(250, 145, 1, 0.5);
}

/* Modal one-time badge positioning (same as card) */
.tnow-modal-image .tnow-onetime-badge {
    top: 12px;
    left: 12px;
}

.tnow-design-card.is-taken {
    opacity: 0.7;
}

.tnow-design-card.is-taken:hover {
    opacity: 0.85;
}

.tnow-book-btn.disabled {
    background: var(--tnow-gray) !important;
    cursor: not-allowed;
    pointer-events: none;
}

.tnow-taken-notice {
    background: rgba(139, 0, 0, 0.2);
    border: 1px solid rgba(139, 0, 0, 0.5);
    border-radius: var(--radius-sm);
    padding: 0.75rem 1rem;
    margin-bottom: 1rem;
    color: #ff6b6b;
    font-size: 0.9rem;
    text-align: center;
}

.tnow-onetime-notice {
    background: rgba(250, 145, 1, 0.15);
    border: 1px solid rgba(250, 145, 1, 0.4);
    border-radius: var(--radius-sm);
    padding: 0.75rem 1rem;
    margin-bottom: 1rem;
    color: var(--tnow-orange);
    font-size: 0.9rem;
    text-align: center;
}

.tnow-design-info {
    padding: 1rem;
}

.tnow-design-title {
    font-family: var(--font-headline);
    font-size: 1rem;
    font-weight: 700;
    margin: 0 0 0.5rem 0;
    color: var(--tnow-white);
    line-height: 1.3;
}

.tnow-design-category {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    color: var(--text-muted);
    text-transform: uppercase;
}

.tnow-design-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 50%);
    display: flex;
    align-items: flex-end;
    justify-content: center;
    padding: 1rem;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.tnow-design-card:hover .tnow-design-overlay {
    opacity: 1;
}

.tnow-view-btn {
    padding: 0.6rem 1.2rem;
    background: var(--tnow-orange);
    border: none;
    border-radius: var(--radius-md);
    color: var(--tnow-black);
    font-weight: 700;
    font-size: 0.8rem;
    text-transform: uppercase;
    cursor: pointer;
}

/* =================================================================
   LOAD MORE
   ================================================================= */
.tnow-load-more-wrap {
    text-align: center;
    padding: 2rem 0;
}

.tnow-showing-count {
    color: var(--text-muted);
    font-size: 0.9rem;
    margin: 0 0 1rem 0;
}

.tnow-load-more-btn {
    padding: 0.875rem 2rem;
    background: transparent;
    border: 2px solid var(--tnow-orange);
    border-radius: var(--radius-md);
    color: var(--tnow-orange);
    font-family: var(--font-body);
    font-weight: 700;
    font-size: 0.9rem;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s ease;
}

.tnow-load-more-btn:hover {
    background: var(--tnow-orange);
    color: var(--tnow-black);
}

/* =================================================================
   MODAL
   ================================================================= */
.tnow-modal {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
}

.tnow-modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(4px);
}

.tnow-modal-content {
    position: relative;
    width: 100%;
    max-width: 900px;
    max-height: 90vh;
    background: var(--tnow-navy);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-lg);
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.tnow-modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    width: 40px;
    height: 40px;
    background: rgba(0, 0, 0, 0.5);
    border: 1px solid var(--card-border);
    border-radius: 50%;
    color: var(--tnow-white);
    font-size: 1.5rem;
    cursor: pointer;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.tnow-modal-close:hover {
    background: var(--tnow-orange);
    color: var(--tnow-black);
    border-color: var(--tnow-orange);
}

.tnow-modal-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 48px;
    height: 48px;
    background: rgba(0, 0, 0, 0.6);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 50%;
    color: var(--tnow-white);
    font-size: 2rem;
    line-height: 1;
    cursor: pointer;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.tnow-modal-nav:hover {
    background: var(--tnow-orange);
    color: var(--tnow-black);
    border-color: var(--tnow-orange);
}

.tnow-modal-nav:disabled {
    opacity: 0.25;
    cursor: default;
    pointer-events: none;
}

.tnow-modal-prev { left: 0.75rem; }
.tnow-modal-next { right: 0.75rem; }

@media (max-width: 639px) {
    .tnow-modal-nav {
        width: 36px;
        height: 36px;
        font-size: 1.5rem;
    }
    .tnow-modal-prev { left: 0.35rem; }
    .tnow-modal-next { right: 0.35rem; }
}

.tnow-modal-body {
    display: flex;
    flex-direction: column;
    overflow-y: auto;
}

.tnow-modal-image {
    position: relative;
    width: 100%;
    max-height: 50vh;
    background: var(--tnow-black);
}

.tnow-modal-image img {
    width: 100%;
    height: 100%;
    object-fit: contain;
}

.tnow-modal-info {
    padding: 1.5rem;
}

.tnow-modal-title {
    font-family: var(--font-headline);
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0 0 0.75rem 0;
    color: var(--tnow-white);
}

.tnow-modal-desc {
    color: var(--text-muted);
    line-height: 1.6;
    margin: 0 0 1.5rem 0;
}

.tnow-modal-meta {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.tnow-meta-item {
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.03);
    border-radius: var(--radius-md);
}

.tnow-meta-label {
    display: block;
    font-size: 0.7rem;
    color: var(--text-muted);
    text-transform: uppercase;
    margin-bottom: 0.25rem;
}

.tnow-meta-value {
    font-weight: 600;
    color: var(--tnow-white);
}

.tnow-meta-value.tnow-price {
    color: var(--tnow-orange);
    font-family: var(--font-headline);
}

.tnow-book-btn {
    display: block;
    width: 100%;
    padding: 1rem;
    background: var(--tnow-orange);
    border: none;
    border-radius: var(--radius-md);
    color: var(--tnow-black);
    font-family: var(--font-body);
    font-weight: 700;
    font-size: 1rem;
    text-transform: uppercase;
    text-align: center;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.2s ease;
}

.tnow-book-btn:hover {
    background: var(--tnow-gold);
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(250, 145, 1, 0.3);
}

/* =================================================================
   RESPONSIVE BREAKPOINTS
   ================================================================= */
@media (min-width: 480px) {
    .tnow-skeleton-grid,
    .tnow-gallery-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (min-width: 640px) {
    .tnow-skeleton-grid,
    .tnow-gallery-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
    }

    .tnow-modal-body {
        flex-direction: row;
    }

    .tnow-modal-image {
        width: 50%;
        max-height: none;
    }

    .tnow-modal-info {
        width: 50%;
        padding: 2rem;
    }
}

@media (min-width: 900px) {
    .tnow-skeleton-grid,
    .tnow-gallery-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 24px;
    }
}

@media (min-width: 1200px) {
    .tnow-skeleton-grid,
    .tnow-gallery-grid {
        grid-template-columns: repeat(5, 1fr);
    }
}

/* Mobile: Show All + 1 category + More link only */
@media (max-width: 480px) {
    .tnow-cat-btn {
        padding: 0.5rem 0.75rem;
        font-size: 0.75rem;
    }

    /* Hide category buttons beyond index 1 on mobile (show All + 1 cat + More) */
    .tnow-cat-btn[data-cat-index="2"],
    .tnow-cat-btn[data-cat-index="3"],
    .tnow-cat-btn[data-cat-index="4"] {
        display: none;
    }

    .tnow-design-info {
        padding: 0.75rem;
    }

    .tnow-design-title {
        font-size: 0.9rem;
    }

    .tnow-modal-meta {
        grid-template-columns: 1fr;
    }
}

/* Small tablet: Show All + 2 categories + More */
@media (min-width: 481px) and (max-width: 640px) {
    .tnow-cat-btn[data-cat-index="3"],
    .tnow-cat-btn[data-cat-index="4"] {
        display: none;
    }
}

/* Medium tablet: Show All + 3 categories + More */
@media (min-width: 641px) and (max-width: 900px) {
    .tnow-cat-btn[data-cat-index="4"] {
        display: none;
    }
}
</style>

<script>
(function() {
    'use strict';

    // =================================================================
    // CONFIGURATION
    // =================================================================

    // Helper to get and persist locationId across pages
    function getLocationId() {
        var storageKey = 'tnow_location_id';
        var urlParam = new URLSearchParams(window.location.search).get('locationId');

        // Priority: window override > URL param > localStorage > GHL merge field
        if (window.TNOW_LOCATION_ID) {
            try { localStorage.setItem(storageKey, window.TNOW_LOCATION_ID); } catch(e) {}
            return window.TNOW_LOCATION_ID;
        }

        if (urlParam) {
            try { localStorage.setItem(storageKey, urlParam); } catch(e) {}
            return urlParam;
        }

        try {
            var stored = localStorage.getItem(storageKey);
            if (stored) return stored;
        } catch(e) {}

        // Fall back to GHL merge field (will be literal string if not in GHL context)
        var ghlId = '{{location.id}}';
        if (ghlId && !ghlId.match(/\{\{.*\}\}/)) {
            try { localStorage.setItem(storageKey, ghlId); } catch(e) {}
            return ghlId;
        }

        return null;
    }

    var CONFIG = {
        // Supabase REST API
        supabaseUrl: 'https://ztueqtlqsjsfxskmyrgg.supabase.co',
        supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0dWVxdGxxc2pzZnhza215cmdnIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MDgzMzIwNSwiZXhwIjoyMDg2NDA5MjA1fQ.9bgNwxrYQST3iY6J7OKRgyxeogjU9_jOHFAf29nDGk8',
        restBase: 'https://ztueqtlqsjsfxskmyrgg.supabase.co/rest/v1',

        // GHL Location ID - persisted across pages via localStorage
        locationId: getLocationId(),

        // Calendar booking URL - uses GHL custom value with fallback
        calendarUrl: window.TNOW_CALENDAR_URL || '{{custom_values.03__consultation_calendar}}',
        defaultCalendarUrl: '/consultation',

        // Categories page URL - for "More" link
        categoriesPageUrl: window.TNOW_CATEGORIES_URL || window.location.origin + '/tattoo-design-categories',

        // Design form page URL - for individual design links
        designFormUrl: window.TNOW_DESIGN_FORM_URL || '/tattoo-design-form',

        // Cache settings
        cacheKey: 'tnow_gallery_cache',
        cacheTTL: 5 * 60 * 1000 // 5 minutes
    };

    // Supabase headers for REST API calls
    var SUPABASE_HEADERS = {
        'apikey': CONFIG.supabaseKey,
        'Authorization': 'Bearer ' + CONFIG.supabaseKey,
        'Content-Type': 'application/json'
    };

    function supabaseFetch(path, options) {
        var opts = options || {};
        var headers = Object.assign({}, SUPABASE_HEADERS, opts.headers || {});
        return fetch(CONFIG.restBase + path, {
            method: opts.method || 'GET',
            headers: headers
        })
        .then(function(r) {
            if (!r.ok) throw new Error('Supabase error: ' + r.status);
            var total = null;
            var contentRange = r.headers.get('Content-Range');
            if (contentRange) {
                var parts = contentRange.split('/');
                if (parts[1]) total = parseInt(parts[1], 10);
            }
            return r.json().then(function(data) {
                return { rows: data, total: total };
            });
        });
    }

    // Category lookup cache (populated after categories fetch)
    var categoryLookup = {}; // id -> { name, slug }

    // =================================================================
    // STATE
    // =================================================================
    var fetchId = 0;  // Tracks latest fetch to ignore stale responses

    var state = {
        designs: [],          // Loaded designs (accumulates on Load More)
        categories: [],
        activeCategory: 'all',
        searchQuery: '',      // Client-side search within loaded designs
        sizeFilter: 'all',    // Server-side filter
        priceFilter: 'all',   // Client-side filter (price ranges need parsing)
        featuredFilter: 'all', // Server-side filter
        isLoading: true,
        isLoadingMore: false,
        error: null,
        selectedDesign: null,
        // Server-side pagination
        offset: 0,
        pageSize: 20,
        total: 0,
        hasMore: false
    };

    // =================================================================
    // DOM ELEMENTS
    // =================================================================
    var els = {};

    function cacheDOMElements() {
        els.root = document.getElementById('tattooGallery');
        els.nav = document.getElementById('galleryNav');
        els.grid = document.getElementById('galleryGrid');
        els.loading = document.getElementById('galleryLoading');
        els.error = document.getElementById('galleryError');
        els.empty = document.getElementById('galleryEmpty');
        els.modal = document.getElementById('galleryModal');
        els.searchInput = document.getElementById('searchInput');
        els.searchClear = document.getElementById('searchClear');
        els.sizeFilter = document.getElementById('sizeFilter');
        els.priceFilter = document.getElementById('priceFilter');
        els.featuredCheckbox = document.getElementById('featuredCheckbox');
        els.loadMoreWrap = document.getElementById('loadMoreWrap');
        els.showingCount = document.getElementById('showingCount');
        els.loadMoreBtn = document.getElementById('loadMoreBtn');
    }

    // =================================================================
    // API FETCHING
    // =================================================================
    function fetchData() {
        setLoading(true);
        hideError();

        // Reset pagination
        state.offset = 0;
        state.designs = [];

        // Fetch categories first (needed for filtering), then designs
        var cachedCategories = loadCategoriesFromCache();

        var categoriesPromise;
        if (cachedCategories) {
            state.categories = cachedCategories;
            // Rebuild lookup
            categoryLookup = {};
            state.categories.forEach(function(c) { categoryLookup[c.id] = { name: c.name, slug: c.slug }; });
            renderCategories();
            categoriesPromise = Promise.resolve();
        } else {
            categoriesPromise = supabaseFetch('/categories?status=eq.Active&order=sort_order.asc&select=id,name,slug,icon,sort_order,type')
                .then(function(result) {
                    state.categories = result.rows.map(function(r) {
                        return { id: r.id, name: r.name, slug: r.slug, icon: r.icon, designCount: 0, type: r.type };
                    });
                    // Build lookup for design -> category name mapping
                    categoryLookup = {};
                    state.categories.forEach(function(c) { categoryLookup[c.id] = { name: c.name, slug: c.slug }; });
                    saveCategoriesToCache();
                    renderCategories();
                });
        }

        // After categories are loaded, fetch designs (so category filter works)
        categoriesPromise
            .then(function() {
                return fetchDesignsPage(0);
            })
            .then(function() {
                // Re-sort categories by design count (most designs first)
                sortCategoriesByDesignCount();
                renderCategories();
                setLoading(false);
            })
            .catch(function(err) {
                console.error('Gallery fetch error:', err);
                showError(err.message);
            });
    }

    function fetchDesignsPage(offset) {
        // Build Supabase PostgREST query
        var filters = ['location_id=eq.' + encodeURIComponent(CONFIG.locationId), 'available=eq.true'];

        // Server-side filters
        if (state.sizeFilter !== 'all') {
            filters.push('size_estimate=eq.' + encodeURIComponent(state.sizeFilter));
        }
        if (state.featuredFilter === 'featured') {
            filters.push('featured=eq.true');
        }
        if (state.searchQuery) {
            filters.push('name=ilike.*' + encodeURIComponent(state.searchQuery) + '*');
        }
        // Category filter: find designs via junction table
        if (state.activeCategory !== 'all') {
            var cat = state.categories.find(function(c) {
                return c.slug === state.activeCategory || c.id === state.activeCategory || c.name === state.activeCategory;
            });
            if (cat) {
                filters.push('design_categories.category_id=eq.' + cat.id);
            }
        }

        var url = '/designs?' + filters.join('&') +
            '&select=*,design_categories!inner(category_id)' +
            '&order=sort_order.asc,created_at.desc' +
            '&offset=' + offset + '&limit=' + state.pageSize;

        // For category filter we need !inner join; without category filter use regular join
        if (state.activeCategory === 'all') {
            url = '/designs?' + filters.join('&') +
                '&select=*,design_categories(category_id)' +
                '&order=sort_order.asc,created_at.desc' +
                '&offset=' + offset + '&limit=' + state.pageSize;
        }

        var thisFetchId = ++fetchId;

        return supabaseFetch(url, {
            headers: { 'Prefer': 'count=exact', 'Range-Unit': 'items', 'Range': offset + '-' + (offset + state.pageSize - 1) }
        })
        .then(function(result) {
            if (thisFetchId !== fetchId) return;

            // Transform rows to frontend format
            var designs = result.rows.map(function(row) {
                var catIds = (row.design_categories || []).map(function(dc) { return dc.category_id; });
                var catNames = catIds.map(function(id) {
                    var c = categoryLookup[id];
                    return c ? c.name : null;
                }).filter(Boolean);

                return {
                    id: row.id, name: row.name, description: row.description,
                    image: row.image, thumbnail: row.thumbnail,
                    sizeEstimate: row.size_estimate, timeEstimate: row.time_estimate,
                    priceRange: row.price_range, bodyPart: row.body_part,
                    featured: row.featured, status: row.status,
                    oneTimeFlash: row.one_time_flash,
                    categoryId: catIds[0] || null, categoryIds: catIds,
                    categoryName: catNames[0] || '', categoryNames: catNames
                };
            });

            if (offset === 0) {
                state.designs = designs;
            } else {
                state.designs = state.designs.concat(designs);
            }

            var total = result.total || designs.length;
            state.offset = offset;
            state.total = total;
            state.hasMore = (offset + designs.length) < total;

            renderDesigns();
        });
    }

    function loadMoreFromServer() {
        if (state.isLoadingMore || !state.hasMore) return;

        state.isLoadingMore = true;
        updateLoadMoreButton();

        var nextOffset = state.offset + state.pageSize;

        fetchDesignsPage(nextOffset)
            .then(function() {
                state.isLoadingMore = false;
                updateLoadMoreButton();
            })
            .catch(function(err) {
                console.error('Load more error:', err);
                state.isLoadingMore = false;
                updateLoadMoreButton();
            });
    }

    function updateLoadMoreButton() {
        if (els.loadMoreBtn) {
            els.loadMoreBtn.textContent = state.isLoadingMore ? 'Loading...' : 'Load More';
            els.loadMoreBtn.disabled = state.isLoadingMore;
        }
    }

    function refetchDesigns() {
        // Called when filters change - reset and fetch fresh
        state.offset = 0;
        state.designs = [];
        hideError();
        setLoading(true);

        var thisFetchId = fetchId + 1; // Will be incremented by fetchDesignsPage

        fetchDesignsPage(0)
            .then(function() {
                if (thisFetchId === fetchId) setLoading(false);
            })
            .catch(function(err) {
                if (thisFetchId === fetchId) {
                    console.error('Refetch error:', err);
                    showError(err.message);
                }
            });
    }

    // =================================================================
    // CACHING (Categories only - designs are paginated from server)
    // =================================================================
    function loadCategoriesFromCache() {
        try {
            // Categories are NOT location-specific, so cache without locationId
            var key = CONFIG.cacheKey + '_categories';
            var cached = localStorage.getItem(key);
            if (cached) {
                var data = JSON.parse(cached);
                // Categories can be cached longer (30 min) since they rarely change
                if (Date.now() - data.timestamp < 30 * 60 * 1000) {
                    return data.categories;
                }
            }
        } catch (e) {
            console.warn('Cache read error:', e);
        }
        return null;
    }

    function saveCategoriesToCache() {
        try {
            // Categories are NOT location-specific, so cache without locationId
            var key = CONFIG.cacheKey + '_categories';
            localStorage.setItem(key, JSON.stringify({
                timestamp: Date.now(),
                categories: state.categories
            }));
        } catch (e) {
            console.warn('Cache write error:', e);
        }
    }

    function clearCache() {
        try {
            var key = CONFIG.cacheKey + '_categories';
            localStorage.removeItem(key);
        } catch (e) {}
    }

    // =================================================================
    // RENDERING
    // =================================================================
    function sortCategoriesByDesignCount() {
        state.categories.sort(function(a, b) {
            var countA = a.designCount || 0;
            var countB = b.designCount || 0;
            return countB - countA; // Most designs first
        });
        // Remove categories with no designs
        state.categories = state.categories.filter(function(cat) {
            return (cat.designCount || 0) > 0;
        });
    }

    function renderCategories() {
        // Show first N categories as main buttons, rest hidden (accessible via "More" link)
        // Mobile: 2 categories + All + More = 4 buttons
        // Tablet: 4 categories + All + More = 6 buttons
        // Desktop: 4 categories + All + More = 6 buttons (or more if space)
        var mainCount = 4;
        var mainCategories = state.categories.slice(0, mainCount);
        var moreCategories = state.categories.slice(mainCount);

        // Build main buttons HTML - "All" button first
        var html = '<button class="tnow-cat-btn" data-category="all" data-cat-index="0" data-active="' + (state.activeCategory === 'all') + '">' +
                   '<span class="tnow-cat-icon">‚ú®</span>' +
                   '<span class="tnow-cat-label">All</span>' +
                   '</button>';

        // Add category buttons with index for responsive hiding
        mainCategories.forEach(function(cat, index) {
            var isActive = state.activeCategory === cat.slug;
            html += '<button class="tnow-cat-btn" data-category="' + cat.slug + '" data-cat-index="' + (index + 1) + '" data-active="' + isActive + '">' +
                    (cat.icon ? '<span class="tnow-cat-icon">' + cat.icon + '</span>' : '') +
                    '<span class="tnow-cat-label">' + escapeHtml(cat.name) + '</span>' +
                    '</button>';
        });

        // Always add "More" link to categories page (for full category browsing)
        var moreHasActive = state.activeCategory !== 'all' &&
                           !mainCategories.some(function(cat) { return state.activeCategory === cat.slug; });

        var categoriesUrl = CONFIG.categoriesPageUrl;
        if (CONFIG.locationId) {
            categoriesUrl += (categoriesUrl.indexOf('?') > -1 ? '&' : '?') + 'locationId=' + encodeURIComponent(CONFIG.locationId);
        }

        html += '<a href="' + escapeHtml(categoriesUrl) + '" class="tnow-cat-btn tnow-more-link" data-active="' + moreHasActive + '">' +
                '<span class="tnow-cat-icon">‚Ä¢‚Ä¢‚Ä¢</span>' +
                '<span class="tnow-cat-label">More</span>' +
                '</a>';

        els.nav.innerHTML = html;
        bindCategoryEvents();
    }

    function renderDesigns() {
        // Client-side filtering (like admin does - more reliable)
        var filtered = state.designs;

        // Apply client-side category filter (like admin does)
        if (state.activeCategory !== 'all') {
            filtered = filtered.filter(function(d) {
                // Find the category to match against
                var cat = state.categories.find(function(c) {
                    return c.slug === state.activeCategory ||
                           c.id === state.activeCategory ||
                           c.name === state.activeCategory;
                });
                if (cat) {
                    // Match by categoryIds array or fallback to single categoryId
                    var catIds = d.categoryIds || (d.categoryId ? [d.categoryId] : []);
                    var catNames = d.categoryNames || (d.categoryName ? [d.categoryName] : []);
                    return catIds.indexOf(cat.id) !== -1 || catNames.indexOf(cat.name) !== -1;
                }
                // Fallback: match by name directly
                var names = d.categoryNames || (d.categoryName ? [d.categoryName] : []);
                return names.indexOf(state.activeCategory) !== -1;
            });
        }

        // Apply client-side price filter (needs parsing)
        if (state.priceFilter !== 'all') {
            filtered = filtered.filter(function(d) {
                var minPrice = extractMinPrice(d.priceRange);
                if (minPrice === null) return false;
                switch (state.priceFilter) {
                    case 'under500': return minPrice < 500;
                    case '500to1000': return minPrice >= 500 && minPrice < 1000;
                    case '1000to2000': return minPrice >= 1000 && minPrice < 2000;
                    case 'over2000': return minPrice >= 2000;
                    default: return true;
                }
            });
        }

        if (filtered.length === 0 && state.designs.length === 0) {
            els.grid.style.display = 'none';
            els.empty.style.display = 'block';
            els.loadMoreWrap.style.display = 'none';
            // Update empty state message based on context
            var emptyIcon = document.getElementById('emptyIcon');
            var emptyMsg = document.getElementById('emptyMessage');
            var emptyAction = document.getElementById('emptyAction');
            if (state.searchQuery) {
                emptyIcon.textContent = 'üîç';
                emptyMsg.textContent = 'No designs found for "' + state.searchQuery + '"';
                emptyAction.textContent = 'Clear Search';
                emptyAction.onclick = function() { clearSearch(); };
            } else if (state.activeCategory !== 'all' || state.sizeFilter !== 'all' || state.priceFilter !== 'all' || state.featuredFilter !== 'all') {
                emptyIcon.textContent = 'üîç';
                emptyMsg.textContent = 'No designs match the current filters.';
                emptyAction.textContent = 'Clear Filters';
                emptyAction.onclick = function() { clearFilters(); };
            } else {
                emptyIcon.textContent = 'üé®';
                emptyMsg.textContent = 'No designs available yet.';
                emptyAction.textContent = 'Check Back Later';
                emptyAction.onclick = function() { window.TattooGallery.refresh(); };
            }
            return;
        }

        // Handle case where search/price filter finds nothing in loaded designs
        if (filtered.length === 0) {
            els.grid.style.display = 'none';
            els.empty.style.display = 'block';
            els.loadMoreWrap.style.display = 'none';
            var emptyIcon = document.getElementById('emptyIcon');
            var emptyMsg = document.getElementById('emptyMessage');
            var emptyAction = document.getElementById('emptyAction');
            if (state.searchQuery) {
                emptyIcon.textContent = 'üîç';
                emptyMsg.textContent = 'No designs found for "' + state.searchQuery + '"';
                emptyAction.textContent = 'Clear Search';
                emptyAction.onclick = function() { clearSearch(); };
            } else {
                emptyIcon.textContent = 'üí∞';
                emptyMsg.textContent = 'No designs in this price range.';
                emptyAction.textContent = 'Clear Price Filter';
                emptyAction.onclick = function() { clearPriceFilter(); };
            }
            return;
        }

        els.empty.style.display = 'none';
        els.grid.style.display = 'grid';

        var html = '';
        filtered.forEach(function(design) {
            var categoryName = (design.categoryNames || [design.categoryName]).filter(Boolean).join(' ¬∑ ') || getCategoryName(design.categoryId);
            var isTaken = design.status === 'Taken' && design.oneTimeFlash;
            var cardClass = 'tnow-design-card' + (isTaken ? ' is-taken' : '');
            html += '<div class="' + cardClass + '" data-id="' + design.id + '" onclick="TattooGallery.openModal(\'' + design.id + '\')">' +
                    '<div class="tnow-design-image" oncontextmenu="return false;">' +
                    (design.thumbnail || design.image
                        ? '<img src="' + escapeHtml(design.thumbnail || design.image) + '" alt="' + escapeHtml(design.name) + '" loading="lazy" draggable="false">'
                        : '<div class="tnow-design-placeholder">üé®</div>') +
                    '<div class="tnow-watermark-overlay"></div>' +
                    '<div class="tnow-watermark-tiles"></div>' +
                    '<span class="tnow-watermark-logo">TattooNOW</span>' +
                    (design.featured ? '<span class="tnow-featured-badge">Featured</span>' : '') +
                    (isTaken ? '<span class="tnow-taken-badge">Taken</span>' : '') +
                    (design.oneTimeFlash && !isTaken ? '<span class="tnow-onetime-badge">1x Design</span>' : '') +
                    '<div class="tnow-design-overlay"><button class="tnow-view-btn">View Details</button></div>' +
                    '</div>' +
                    '<div class="tnow-design-info">' +
                    '<h3 class="tnow-design-title">' + escapeHtml(design.name) + '</h3>' +
                    '<span class="tnow-design-category">' + escapeHtml(categoryName) + '</span>' +
                    '</div>' +
                    '</div>';
        });

        els.grid.innerHTML = html;

        // Update load more section based on server pagination
        var showingCount = filtered.length;
        var totalFromServer = state.total;

        if (state.hasMore) {
            els.showingCount.textContent = 'Showing ' + showingCount + ' of ' + totalFromServer + ' designs';
            els.loadMoreWrap.style.display = 'block';
            els.loadMoreBtn.style.display = 'inline-block';
        } else if (showingCount < state.designs.length) {
            // All pages loaded but client-side price filter reduced the count
            els.showingCount.textContent = 'Showing ' + showingCount + ' of ' + state.designs.length + ' designs';
            els.loadMoreWrap.style.display = 'block';
            els.loadMoreBtn.style.display = 'none';
        } else if (showingCount > 0) {
            els.showingCount.textContent = showingCount + ' designs';
            els.loadMoreWrap.style.display = 'block';
            els.loadMoreBtn.style.display = 'none';
        } else {
            els.loadMoreWrap.style.display = 'none';
        }
    }

    function getCategoryName(categoryId) {
        var cat = state.categories.find(function(c) { return c.id === categoryId; });
        return cat ? cat.name : 'Uncategorized';
    }

    // =================================================================
    // MODAL
    // =================================================================
    function openModal(designId) {
        var design = state.designs.find(function(d) { return d.id === designId; });
        if (!design) return;

        state.selectedDesign = design;

        document.getElementById('modalImage').src = design.image || '';
        document.getElementById('modalImage').alt = design.name;
        document.getElementById('modalTitle').textContent = design.name;
        document.getElementById('modalDescription').textContent = design.description || 'No description available.';

        // Featured badge
        document.getElementById('modalFeatured').style.display = design.featured ? 'block' : 'none';

        // Taken status (for one-time flash designs)
        var isTaken = design.status === 'Taken' && design.oneTimeFlash;
        document.getElementById('modalTaken').style.display = isTaken ? 'block' : 'none';
        document.getElementById('modalTakenNotice').style.display = isTaken ? 'block' : 'none';

        // One-time flash badge and notice (shows when available, not taken)
        var isOneTimeAvailable = design.oneTimeFlash && !isTaken;
        document.getElementById('modalOneTime').style.display = isOneTimeAvailable ? 'block' : 'none';
        document.getElementById('modalOneTimeNotice').style.display = isOneTimeAvailable ? 'block' : 'none';

        // Add/remove is-taken class on modal image for stronger protection
        var modalImage = document.querySelector('.tnow-modal-image');
        if (isTaken) {
            modalImage.classList.add('is-taken');
        } else {
            modalImage.classList.remove('is-taken');
        }

        // Meta fields - show/hide based on content
        setMetaField('modalSize', 'modalSizeWrap', design.sizeEstimate);
        setMetaField('modalTime', 'modalTimeWrap', design.timeEstimate);
        setMetaField('modalPrice', 'modalPriceWrap', design.priceRange);
        setMetaField('modalBodyPart', 'modalBodyPartWrap', design.bodyPart);
        setMetaField('modalCategory', 'modalCategoryWrap', (design.categoryNames || [design.categoryName]).filter(Boolean).join(' ¬∑ '));

        // Link to design form page with designId
        var designFormUrl = CONFIG.designFormUrl + '?05._online_design_id=' + encodeURIComponent(designId);
        var bookBtn = document.getElementById('modalBookBtn');
        bookBtn.href = isTaken ? '#' : designFormUrl;
        bookBtn.textContent = isTaken ? 'Design Taken' : 'Request This Design';
        if (isTaken) {
            bookBtn.classList.add('disabled');
        } else {
            bookBtn.classList.remove('disabled');
        }

        updateNavButtons(design.id);
        els.modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    function getFilteredDesigns() {
        var filtered = state.designs;
        if (state.activeCategory !== 'all') {
            filtered = filtered.filter(function(d) {
                var cat = state.categories.find(function(c) {
                    return c.slug === state.activeCategory || c.id === state.activeCategory || c.name === state.activeCategory;
                });
                if (cat) {
                    var catIds = d.categoryIds || (d.categoryId ? [d.categoryId] : []);
                    var catNames = d.categoryNames || (d.categoryName ? [d.categoryName] : []);
                    return catIds.indexOf(cat.id) !== -1 || catNames.indexOf(cat.name) !== -1;
                }
                var names = d.categoryNames || (d.categoryName ? [d.categoryName] : []);
                return names.indexOf(state.activeCategory) !== -1;
            });
        }
        if (state.priceFilter !== 'all') {
            filtered = filtered.filter(function(d) {
                var minPrice = extractMinPrice(d.priceRange);
                if (minPrice === null) return false;
                switch (state.priceFilter) {
                    case 'under500': return minPrice < 500;
                    case '500to1000': return minPrice >= 500 && minPrice < 1000;
                    case '1000to2000': return minPrice >= 1000 && minPrice < 2000;
                    case 'over2000': return minPrice >= 2000;
                    default: return true;
                }
            });
        }
        return filtered;
    }

    function updateNavButtons(designId) {
        var filtered = getFilteredDesigns();
        var idx = -1;
        for (var i = 0; i < filtered.length; i++) {
            if (filtered[i].id === designId) { idx = i; break; }
        }
        document.getElementById('modalPrev').disabled = (idx <= 0);
        document.getElementById('modalNext').disabled = (idx < 0 || idx >= filtered.length - 1);
    }

    function navPrev() {
        if (!state.selectedDesign) return;
        var filtered = getFilteredDesigns();
        var idx = -1;
        for (var i = 0; i < filtered.length; i++) {
            if (filtered[i].id === state.selectedDesign.id) { idx = i; break; }
        }
        if (idx > 0) openModal(filtered[idx - 1].id);
    }

    function navNext() {
        if (!state.selectedDesign) return;
        var filtered = getFilteredDesigns();
        var idx = -1;
        for (var i = 0; i < filtered.length; i++) {
            if (filtered[i].id === state.selectedDesign.id) { idx = i; break; }
        }
        if (idx >= 0 && idx < filtered.length - 1) openModal(filtered[idx + 1].id);
    }

    function setMetaField(valueId, wrapId, value) {
        var valueEl = document.getElementById(valueId);
        var wrapEl = document.getElementById(wrapId);
        if (value) {
            valueEl.textContent = value;
            wrapEl.style.display = 'block';
        } else {
            wrapEl.style.display = 'none';
        }
    }

    function closeModal() {
        els.modal.style.display = 'none';
        document.body.style.overflow = '';
        state.selectedDesign = null;
    }

    // =================================================================
    // STATE MANAGEMENT
    // =================================================================
    function setLoading(isLoading) {
        state.isLoading = isLoading;
        els.loading.style.display = isLoading ? 'block' : 'none';
        if (isLoading) {
            els.grid.style.display = 'none';
            els.empty.style.display = 'none';
        }
    }

    function showError(message) {
        state.error = message;
        els.loading.style.display = 'none';
        els.grid.style.display = 'none';
        els.empty.style.display = 'none';
        els.error.style.display = 'block';
    }

    function hideError() {
        els.error.style.display = 'none';
        state.error = null;
    }

    // =================================================================
    // EVENT BINDING
    // =================================================================
    function bindCategoryEvents() {
        els.nav.querySelectorAll('.tnow-cat-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var category = this.getAttribute('data-category');
                filterCategory(category);
            });
        });
    }

    function filterCategory(category) {
        if (state.activeCategory === category) return;

        state.activeCategory = category;

        // Update active state on buttons
        els.nav.querySelectorAll('.tnow-cat-btn').forEach(function(btn) {
            var isActive = btn.getAttribute('data-category') === category;
            btn.setAttribute('data-active', isActive.toString());
        });

        // Server-side filter - refetch
        refetchDesigns();
    }

    function bindGlobalEvents() {
        // Keyboard navigation for modal
        document.addEventListener('keydown', function(e) {
            if (els.modal.style.display === 'none') return;
            if (e.key === 'Escape') closeModal();
            if (e.key === 'ArrowLeft') navPrev();
            if (e.key === 'ArrowRight') navNext();
        });

        // Search input - server-side search with debounce
        if (els.searchInput) {
            els.searchInput.addEventListener('input', function(e) {
                var query = e.target.value.trim();
                state.searchQuery = query;
                els.searchClear.style.display = query ? 'flex' : 'none';
                // Use debounced server-side search for full database search
                debouncedSearch();
            });
        }

        // Search clear button
        if (els.searchClear) {
            els.searchClear.addEventListener('click', function() {
                clearSearch();
            });
        }

        // Size filter dropdown - server-side
        if (els.sizeFilter) {
            els.sizeFilter.addEventListener('change', function(e) {
                state.sizeFilter = e.target.value;
                refetchDesigns(); // Server-side filter
            });
        }

        // Price filter dropdown - client-side (needs parsing)
        if (els.priceFilter) {
            els.priceFilter.addEventListener('change', function(e) {
                state.priceFilter = e.target.value;
                renderDesigns(); // Client-side filter
            });
        }

        // Featured filter checkbox - server-side
        if (els.featuredCheckbox) {
            els.featuredCheckbox.addEventListener('change', function(e) {
                state.featuredFilter = e.target.checked ? 'featured' : 'all';
                refetchDesigns(); // Server-side filter
            });
        }
    }

    function clearSearch() {
        state.searchQuery = '';
        if (els.searchInput) els.searchInput.value = '';
        if (els.searchClear) els.searchClear.style.display = 'none';
        refetchDesigns(); // Server-side search
    }

    function clearPriceFilter() {
        state.priceFilter = 'all';
        if (els.priceFilter) els.priceFilter.value = 'all';
        renderDesigns(); // Client-side only
    }

    function clearFilters() {
        var needsRefetch = state.sizeFilter !== 'all' ||
                          state.featuredFilter !== 'all' ||
                          state.activeCategory !== 'all';

        state.activeCategory = 'all';
        state.sizeFilter = 'all';
        state.priceFilter = 'all';
        state.featuredFilter = 'all';
        state.searchQuery = '';

        // Update UI
        if (els.sizeFilter) els.sizeFilter.value = 'all';
        if (els.priceFilter) els.priceFilter.value = 'all';
        if (els.featuredCheckbox) els.featuredCheckbox.checked = false;
        if (els.searchInput) els.searchInput.value = '';
        if (els.searchClear) els.searchClear.style.display = 'none';

        // Update category buttons
        els.nav.querySelectorAll('.tnow-cat-btn').forEach(function(btn) {
            var isActive = btn.getAttribute('data-category') === 'all';
            btn.setAttribute('data-active', isActive.toString());
        });

        if (needsRefetch) {
            refetchDesigns(); // Server-side filters changed
        } else {
            renderDesigns(); // Only client-side filters
        }
    }

    function loadMore() {
        loadMoreFromServer();
    }

    // =================================================================
    // UTILITIES
    // =================================================================
    function debounce(func, wait) {
        var timeout;
        return function() {
            var context = this, args = arguments;
            clearTimeout(timeout);
            timeout = setTimeout(function() {
                func.apply(context, args);
            }, wait);
        };
    }

    // Debounced search function for server-side search
    var debouncedSearch = debounce(function() {
        refetchDesigns();
    }, 400);

    function escapeHtml(text) {
        if (!text) return '';
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function extractMinPrice(priceRange) {
        if (!priceRange) return null;
        var match = priceRange.match(/\$?([\d,]+)/);
        if (match) {
            return parseInt(match[1].replace(/,/g, ''), 10);
        }
        return null;
    }

    // =================================================================
    // PUBLIC API
    // =================================================================
    window.TattooGallery = {
        load: fetchData,
        refresh: function() {
            clearCache();
            state.searchQuery = '';
            state.activeCategory = 'all';
            state.sizeFilter = 'all';
            state.priceFilter = 'all';
            state.featuredFilter = 'all';
            if (els.searchInput) els.searchInput.value = '';
            if (els.searchClear) els.searchClear.style.display = 'none';
            if (els.sizeFilter) els.sizeFilter.value = 'all';
            if (els.priceFilter) els.priceFilter.value = 'all';
            if (els.featuredCheckbox) els.featuredCheckbox.checked = false;
            fetchData();
        },
        openModal: openModal,
        closeModal: closeModal,
        navPrev: navPrev,
        navNext: navNext,
        filterCategory: filterCategory,
        search: function(query) {
            state.searchQuery = query || '';
            if (els.searchInput) els.searchInput.value = state.searchQuery;
            if (els.searchClear) els.searchClear.style.display = state.searchQuery ? 'flex' : 'none';
            refetchDesigns(); // Server-side search
        },
        clearSearch: clearSearch,
        clearFilters: clearFilters,
        clearPriceFilter: clearPriceFilter,
        loadMore: loadMore,
        getState: function() { return state; },
        getConfig: function() { return CONFIG; },
        // For debugging pagination
        getPagination: function() {
            return {
                offset: state.offset,
                total: state.total,
                loaded: state.designs.length,
                hasMore: state.hasMore
            };
        }
    };

    // =================================================================
    // INITIALIZE
    // =================================================================
    function init() {
        cacheDOMElements();
        bindGlobalEvents();

        // Check for category in URL params (from categories page link)
        var urlParams = new URLSearchParams(window.location.search);
        var categoryParam = urlParams.get('category');
        if (categoryParam) {
            state.activeCategory = categoryParam;
        }

        fetchData();
    }

    // Run on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
</script>
